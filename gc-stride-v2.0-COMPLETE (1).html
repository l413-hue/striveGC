<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="GC Stride - Comprehensive health monitoring and wellness tracking with Apple Watch integration">
  <meta name="theme-color" content="#D97757">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GC Stride">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 160'><rect x='20' y='20' width='120' height='120' rx='20' fill='%23D97757'/><circle cx='48' cy='48' r='10' fill='white'/><circle cx='80' cy='48' r='10' fill='white'/><circle cx='112' cy='48' r='10' fill='white'/><circle cx='48' cy='80' r='10' fill='white'/><circle cx='80' cy='80' r='10' fill='white'/><circle cx='112' cy='80' r='10' fill='white'/><circle cx='48' cy='112' r='10' fill='white'/><circle cx='80' cy='112' r='10' fill='white'/><circle cx='112' cy='112' r='10' fill='white'/></svg>">
  <link rel="manifest" href="data:application/manifest+json,{'name':'GC Stride','short_name':'GC Stride','start_url':'/','display':'standalone','background_color':'%232F2F2F','theme_color':'%23D97757','icons':[{'src':'data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 512 512\'><rect width=\'512\' height=\'512\' rx=\'128\' fill=\'%23D97757\'/><circle cx=\'160\' cy=\'160\' r=\'40\' fill=\'white\'/><circle cx=\'256\' cy=\'160\' r=\'40\' fill=\'white\'/><circle cx=\'352\' cy=\'160\' r=\'40\' fill=\'white\'/><circle cx=\'160\' cy=\'256\' r=\'40\' fill=\'white\'/><circle cx=\'256\' cy=\'256\' r=\'40\' fill=\'white\'/><circle cx=\'352\' cy=\'256\' r=\'40\' fill=\'white\'/><circle cx=\'160\' cy=\'352\' r=\'40\' fill=\'white\'/><circle cx=\'256\' cy=\'352\' r=\'40\' fill=\'white\'/><circle cx=\'352\' cy=\'352\' r=\'40\' fill=\'white\'/></svg>','sizes':'512x512','type':'image/svg+xml','purpose':'any maskable'}]}">
  <title>GC Stride - Health & Wellness Tracker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=SF+Mono:wght@400;600&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #E8E8E8;
      --bg-dark: #2F2F2F;
      --accent-primary: #D97757;
      --accent-secondary: #CC785D;
      --accent-teal: #7DBEAA;
      --accent-light: #F5E6E0;
      --accent-success: #5BA883;
      --accent-warning: #E8A05D;
      --text-primary: #1A1A1A;
      --text-secondary: #6B6B6B;
      --text-tertiary: #999999;
      --text-on-dark: #FFFFFF;
      --separator: #E0E0E0;
      --separator-dark: #404040;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
      background: #2F2F2F;
      color: var(--text-primary);
      line-height: 1.47059;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: left;
      padding: 40px 20px 32px 20px;
      margin-bottom: 48px;
    }
    
    .logo {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 8px;
    }
    
    .logo-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .logo-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0;
    }
    
    .header h1 {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 1.625em;
      font-weight: 300;
      color: #FFFFFF;
      margin: 0;
      letter-spacing: 0.02em;
      line-height: 1;
      text-transform: uppercase;
    }
    
    .header p {
      display: none;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      justify-content: flex-start;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      background: var(--accent-primary);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 0.875em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease-out;
      border-radius: 8px;
      letter-spacing: 0.03em;
      min-height: 44px;
      box-shadow: var(--shadow-sm);
      text-transform: uppercase;
    }
    
    .btn:hover {
      background: #C8654A;
      box-shadow: var(--shadow-md);
    }
    
    .btn:active {
      transform: scale(0.97);
      transition: transform 0.1s ease-out;
    }
    
    .btn-primary {
      background: var(--accent-primary);
      font-weight: 600;
    }
    
    .btn-primary:hover {
      background: #C8654A;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s ease-out;
      box-shadow: var(--shadow-sm);
    }
    
    .stat-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--accent-teal);
    }
    
    .stat-card:active {
      transform: scale(0.98);
      transition: transform 0.1s ease-out;
    }
    
    .stat-card.hero {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--accent-light) 100%);
      border: 2px solid var(--accent-primary);
      padding: 28px;
      box-shadow: 0 8px 16px rgba(217, 119, 87, 0.15);
      grid-column: 1 / -1;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card.hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent-primary);
    }
    
    .stat-card.hero:hover {
      border-color: var(--accent-secondary);
      box-shadow: 0 12px 24px rgba(217, 119, 87, 0.25);
      transform: translateY(-2px);
    }
    
    .stat-card.hero .stat-value {
      font-size: 3em;
      color: var(--accent-primary);
    }
    
    .stat-card.hero h3 {
      color: var(--accent-primary);
      font-size: 0.875em;
    }
    
    .milestones {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .milestone {
      padding: 4px 10px;
      background: rgba(217, 119, 87, 0.1);
      border-radius: 12px;
      font-size: 0.75em;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .milestone.achieved {
      background: var(--accent-primary);
      color: white;
    }
    
    .stat-card h3 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 0.75em;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    
    .stat-value {
      font-size: 2.25em;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.015em;
      font-variant-numeric: tabular-nums;
      line-height: 1.1;
    }
    
    .stat-card small {
      font-size: 0.8125em;
      color: var(--text-tertiary);
      margin-top: 4px;
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      margin: 12px 0 6px 0;
      overflow: hidden;
      position: relative;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent-primary);
      border-radius: 4px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .progress-percentage {
      position: absolute;
      right: 8px;
      top: -22px;
      font-size: 0.75em;
      font-weight: 600;
      color: var(--accent-primary);
      font-variant-numeric: tabular-nums;
    }
    
    .grace-day-banner {
      background: rgba(50, 215, 75, 0.15);
      border: 0.5px solid rgba(50, 215, 75, 0.3);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 20px;
      text-align: center;
      color: var(--accent-success);
      font-weight: 500;
      font-size: 0.9375em;
      letter-spacing: -0.003em;
    }
    
    .vacation-banner {
      background: rgba(255, 159, 10, 0.15);
      border: 0.5px solid rgba(255, 159, 10, 0.3);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 20px;
      text-align: center;
      color: var(--accent-warning);
      font-weight: 500;
      font-size: 0.9375em;
      letter-spacing: -0.003em;
    }
    
    .reward-banner {
      background: rgba(10, 132, 255, 0.15);
      border: 0.5px solid rgba(10, 132, 255, 0.3);
      border-radius: 14px;
      padding: 18px 20px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .reward-banner h3 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      font-size: 1.125em;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: 0.007em;
    }
    
    .reward-banner p {
      color: var(--text-secondary);
      font-size: 0.9375em;
      margin: 4px 0;
      letter-spacing: -0.003em;
    }
    
    .quick-log-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .quick-log-btn {
      padding: 16px 20px;
      border: 2px solid var(--accent-primary);
      background: var(--bg-secondary);
      color: var(--accent-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 0.9375em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease-out;
      border-radius: 8px;
      letter-spacing: 0.03em;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    
    .quick-log-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent-primary);
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    
    .quick-log-btn:hover::before {
      opacity: 0.1;
    }
    
    .quick-log-btn:hover {
      border-color: var(--accent-secondary);
      box-shadow: 0 0 0 4px rgba(217, 119, 87, 0.1);
      transform: translateY(-2px);
    }
    
    .quick-log-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: var(--shadow-sm);
    }
    
    .section {
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    
    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 60px;
      background: var(--accent-primary);
      border-radius: 12px 0 0 0;
      opacity: 0.3;
    }
    
    .section h2 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      font-size: 1.25em;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-primary);
      letter-spacing: 0.009em;
    }
    
    .checklist-category {
      margin-bottom: 24px;
    }
    
    .checklist-category h3 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 0.9375em;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text-primary);
      letter-spacing: -0.003em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 8px 0;
      transition: all 0.2s ease-out;
    }
    
    .checklist-category h3:hover {
      color: var(--accent-primary);
    }
    
    .category-count {
      font-size: 0.875em;
      color: var(--text-tertiary);
      font-weight: 500;
      background: var(--bg-tertiary);
      padding: 4px 10px;
      border-radius: 12px;
      font-variant-numeric: tabular-nums;
    }
    
    .category-count.complete {
      background: var(--accent-primary);
      color: white;
    }
    
    .collapse-icon {
      margin-left: 8px;
      transition: transform 0.2s ease-out;
      font-size: 0.75em;
    }
    
    .checklist-category.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .checklist-category.collapsed .checklist-item {
      display: none;
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      padding: 14px 0;
      border: none;
      margin-bottom: 0;
      background: transparent;
      border-bottom: 0.5px solid var(--separator);
      transition: all 0.2s ease-out;
      min-height: 52px;
      position: relative;
    }
    
    .checklist-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--accent-primary);
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    
    .checklist-item:hover::before {
      opacity: 0.3;
    }
    
    .checklist-item:last-child {
      border-bottom: none;
    }
    
    .checklist-item:active {
      opacity: 0.6;
    }
    
    .checklist-item input[type="checkbox"] {
      width: 22px;
      height: 22px;
      margin-right: 14px;
      cursor: pointer;
      accent-color: var(--accent-primary);
      flex-shrink: 0;
      transition: all 0.2s ease-out;
    }
    
    .checklist-item input[type="checkbox"]:checked {
      animation: checkBounce 0.4s ease-out;
    }
    
    @keyframes checkBounce {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    @keyframes orangeGlow {
      0% { box-shadow: 0 0 0 0 rgba(217, 119, 87, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(217, 119, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(217, 119, 87, 0); }
    }
    
    .checklist-item.just-checked {
      animation: orangeGlow 0.6s ease-out;
    }
    
    .checklist-item label {
      flex: 1;
      cursor: pointer;
      font-size: 0.9375em;
      color: var(--text-primary);
      font-weight: 400;
      letter-spacing: -0.003em;
      line-height: 1.4;
      transition: all 0.2s ease-out;
    }
    
    .checklist-item.completed {
      opacity: 0.35;
    }
    
    .checklist-item.completed label {
      text-decoration: line-through;
    }
    
    .time-label {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Mono', monospace;
      color: var(--text-tertiary);
      font-weight: 400;
      font-size: 0.8125em;
      margin-right: 14px;
      min-width: 70px;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }
    
    .tracker-input {
      margin-bottom: 20px;
    }
    
    .tracker-input label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 0.8125em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    
    .tracker-input input[type="range"] {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      outline: none;
      border-radius: 3px;
      appearance: none;
      cursor: pointer;
    }
    
    .tracker-input input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 24px;
      height: 24px;
      background: var(--accent-primary);
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.15s ease-out;
      box-shadow: 0 0 0 0.5px rgba(0, 0, 0, 0.04), 0 2px 6px rgba(0, 0, 0, 0.2);
      border: 2px solid white;
    }
    
    .tracker-input input[type="range"]::-webkit-slider-thumb:active {
      transform: scale(1.15);
    }
    
    .tracker-input input[type="number"],
    .tracker-input input[type="text"],
    .tracker-input input[type="email"],
    .tracker-input input[type="time"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--separator);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 1em;
      border-radius: 8px;
      transition: all 0.15s ease-out;
      letter-spacing: -0.003em;
      min-height: 44px;
      box-shadow: var(--shadow-sm);
    }
    
    .tracker-input input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(217, 119, 87, 0.12);
    }
    
    .tracker-input input:hover:not(:focus) {
      border-color: var(--separator);
    }
    
    .slider-value {
      text-align: center;
      font-size: 1.75em;
      font-weight: 600;
      color: var(--accent-teal);
      margin-top: 10px;
      letter-spacing: 0.007em;
      font-variant-numeric: tabular-nums;
    }
    
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px 14px;
      border: 1px solid var(--separator);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 1em;
      border-radius: 8px;
      resize: vertical;
      transition: all 0.15s ease-out;
      letter-spacing: -0.003em;
      line-height: 1.47059;
      box-shadow: var(--shadow-sm);
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(217, 119, 87, 0.12);
    }
    
    textarea:hover:not(:focus) {
      border-color: var(--separator);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      overflow-y: auto;
      backdrop-filter: blur(8px);
      padding: 20px;
    }
    
    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      border-radius: 12px;
      max-width: 720px;
      margin: 60px auto;
      padding: 32px;
      position: relative;
      box-shadow: var(--shadow-lg);
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 1.375em;
      cursor: pointer;
      color: var(--text-tertiary);
      font-weight: 300;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.15s ease-out;
    }
    
    .modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .modal-close:active {
      transform: scale(0.95);
    }
    
    .help-section {
      margin-bottom: 18px;
      padding: 16px;
      border: 1px solid var(--separator);
      background: var(--bg-primary);
      border-radius: 10px;
    }
    
    .help-section h3 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 1em;
      letter-spacing: 0.007em;
    }
    
    .help-section p,
    .help-section ul {
      font-size: 0.9375em;
      color: var(--text-secondary);
      line-height: 1.5;
      letter-spacing: -0.003em;
    }
    
    .help-section ul {
      margin-left: 20px;
      margin-top: 8px;
    }
    
    .help-section li {
      margin-bottom: 6px;
    }
    
    .help-section strong {
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .celebration {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 8em;
      animation: bounce 1s ease;
      z-index: 999;
      pointer-events: none;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.3); }
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-dark);
      color: white;
      padding: 14px 20px;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      max-width: 400px;
    }
    
    @keyframes slideUp {
      from {
        transform: translateX(-50%) translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }
    
    .toast-message {
      flex: 1;
      font-size: 0.9375em;
    }
    
    .toast-action {
      background: var(--accent-primary);
      border: none;
      color: white;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875em;
      transition: all 0.2s ease-out;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    
    .toast-action:hover {
      background: var(--accent-secondary);
    }
    
    .toast-action:active {
      transform: scale(0.95);
    }
    
    .onboarding-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      overflow-y: auto;
      backdrop-filter: blur(10px);
    }
    
    .onboarding-content {
      max-width: 600px;
      margin: 40px auto;
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 40px;
      box-shadow: var(--shadow-lg);
    }
    
    .onboarding-step {
      display: none;
      animation: fadeIn 0.3s ease-out;
    }
    
    .onboarding-step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .onboarding-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .onboarding-header h2 {
      font-size: 2em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .onboarding-header p {
      font-size: 1.125em;
      color: var(--text-secondary);
    }
    
    .watch-icon {
      width: 120px;
      height: 120px;
      margin: 24px auto;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3em;
      box-shadow: 0 8px 24px rgba(217, 119, 87, 0.3);
    }
    
    .integration-option {
      background: var(--bg-primary);
      border: 2px solid var(--separator);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      cursor: pointer;
      transition: all 0.2s ease-out;
    }
    
    .integration-option:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(217, 119, 87, 0.1);
    }
    
    .integration-option.selected {
      border-color: var(--accent-primary);
      background: var(--accent-light);
    }
    
    .integration-option h3 {
      font-size: 1.125em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .integration-option p {
      font-size: 0.9375em;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 8px;
      background: var(--accent-primary);
      color: white;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge.recommended {
      background: var(--accent-success);
    }
    
    .badge.manual {
      background: var(--text-tertiary);
    }
    
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 32px 0 24px 0;
    }
    
    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--separator);
      transition: all 0.2s ease-out;
    }
    
    .step-dot.active {
      background: var(--accent-primary);
      width: 24px;
      border-radius: 4px;
    }
    
    .onboarding-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }
    
    .onboarding-actions .btn {
      flex: 1;
    }
    
    .instruction-list {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .instruction-list li {
      margin-bottom: 12px;
      padding-left: 8px;
      line-height: 1.6;
    }
    
    .code-block {
      background: var(--bg-dark);
      color: var(--accent-teal);
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'SF Mono', monospace;
      font-size: 0.875em;
      margin: 12px 0;
      overflow-x: auto;
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 10px;
      margin: 16px 0;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-tertiary);
      animation: pulse 2s infinite;
    }
    
    .status-indicator.connected {
      background: var(--accent-success);
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .health-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9375em;
      cursor: pointer;
      transition: all 0.2s ease-out;
      white-space: nowrap;
    }
    
    .health-tab:hover {
      color: var(--text-primary);
      background: var(--bg-primary);
    }
    
    .health-tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }
    
    .health-tab-content {
      display: none;
    }
    
    .health-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    .lab-item {
      background: var(--bg-primary);
      border: 1px solid var(--separator);
      border-radius: 10px;
      padding: 16px;
      display: grid;
      grid-template-columns: 120px 1fr 120px 100px 120px auto;
      gap: 16px;
      align-items: center;
      transition: all 0.2s ease-out;
    }
    
    .lab-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--accent-primary);
    }
    
    .lab-date {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .lab-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1em;
    }
    
    .lab-value {
      font-size: 1.5em;
      font-weight: 600;
      color: var(--accent-primary);
      font-variant-numeric: tabular-nums;
    }
    
    .lab-value.warning {
      color: var(--accent-warning);
    }
    
    .lab-value.danger {
      color: #E74C3C;
    }
    
    .lab-range {
      font-size: 0.8125em;
      color: var(--text-tertiary);
    }
    
    .symptom-item {
      background: var(--bg-primary);
      border-left: 4px solid var(--accent-warning);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .symptom-severity {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.875em;
    }
    
    .symptom-severity.low {
      background: rgba(91, 168, 131, 0.2);
      color: var(--accent-success);
    }
    
    .symptom-severity.medium {
      background: rgba(232, 160, 93, 0.2);
      color: var(--accent-warning);
    }
    
    .symptom-severity.high {
      background: rgba(231, 76, 60, 0.2);
      color: #E74C3C;
    }
    
    .med-item {
      background: var(--bg-primary);
      border: 1px solid var(--separator);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    
    .med-item.active {
      border-color: var(--accent-success);
      background: linear-gradient(135deg, var(--bg-primary) 0%, rgba(91, 168, 131, 0.05) 100%);
    }
    
    .med-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .med-name {
      font-weight: 600;
      font-size: 1.125em;
      color: var(--text-primary);
    }
    
    .med-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .med-badge.active {
      background: rgba(91, 168, 131, 0.2);
      color: var(--accent-success);
    }
    
    .med-badge.ended {
      background: rgba(153, 153, 153, 0.2);
      color: var(--text-tertiary);
    }
    
    .settings-grid {
      display: grid;
      gap: 16px;
    }
    
    .setting-item {
      padding: 18px;
      border: 1px solid var(--separator);
      background: var(--bg-primary);
      border-radius: 10px;
    }
    
    .setting-item h4 {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      margin-bottom: 10px;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1em;
      letter-spacing: 0.007em;
    }
    
    .setting-item p {
      font-size: 0.875em;
      color: var(--text-secondary);
      margin-bottom: 12px;
      letter-spacing: -0.003em;
      line-height: 1.4;
    }
    
    .time-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 10px;
    }
    
    .editable-checklist {
      margin-top: 12px;
    }
    
    .editable-item {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .editable-item input {
      flex: 1;
      padding: 10px 12px;
      border: 0.5px solid var(--separator);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 0.9375em;
      border-radius: 8px;
      transition: all 0.15s ease-out;
      letter-spacing: -0.003em;
      min-height: 40px;
    }
    
    .editable-item input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }
    
    .btn-small {
      padding: 8px 14px;
      border: none;
      background: var(--bg-quaternary);
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      cursor: pointer;
      font-weight: 400;
      font-size: 0.875em;
      border-radius: 12px;
      transition: all 0.15s ease-out;
      letter-spacing: -0.003em;
      min-height: 36px;
    }
    
    .btn-small:hover {
      background: var(--bg-tertiary);
    }
    
    .btn-small:active {
      transform: scale(0.95);
    }
    
    @media (max-width: 768px) {
      .header {
        padding: 32px 20px 28px 20px;
      }
      
      .logo {
        gap: 12px;
      }
      
      .logo-icon {
        width: 42px;
        height: 42px;
      }
      
      .header h1 {
        font-size: 1.375em;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .quick-log-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .controls {
        gap: 10px;
      }
      
      .btn {
        font-size: 0.8125em;
      }
      
      .modal-content {
        margin: 20px auto;
        padding: 24px;
      }
      
      .section {
        padding: 20px;
      }
    }
    
    @media (max-width: 480px) {
      body {
        padding: 16px;
      }
      
      .header {
        padding: 24px 16px 24px 16px;
      }
      
      .logo {
        gap: 10px;
      }
      
      .logo-icon {
        width: 36px;
        height: 36px;
      }
      
      .header h1 {
        font-size: 1.25em;
      }
      
      .modal-content {
        padding: 20px;
      }
    }
    
    /* ==================== V2.0 CALENDAR & REFLECTION FEATURES ==================== */
    
    /* Calendar View Styles */
    .calendar-view {
      display: none;
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
    }
    
    .calendar-view.active {
      display: block;
    }
    
    .calendar-header-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .calendar-header-controls h2 {
      font-size: 1.5em;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }
    
    .calendar-nav {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .calendar-nav button {
      background: var(--bg-secondary);
      border: 1px solid var(--separator);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 0.9375em;
    }
    
    .calendar-nav button:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }
    
    .calendar-month-year {
      font-size: 1.125em;
      font-weight: 600;
      color: var(--text-primary);
      min-width: 200px;
      text-align: center;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 16px;
    }
    
    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      font-size: 0.875em;
      color: var(--text-tertiary);
      padding: 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border-radius: 12px;
      padding: 12px 8px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      background: var(--bg-secondary);
      border: 2px solid var(--separator);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 80px;
    }
    
    .calendar-day.empty {
      background: transparent;
      border: none;
      cursor: default;
    }
    
    .calendar-day.today {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(217, 119, 87, 0.2);
    }
    
    .calendar-day.future {
      opacity: 0.5;
      cursor: default;
    }
    
    .calendar-day.completion-none {
      background: linear-gradient(135deg, #F5F5F5 0%, #E8E8E8 100%);
    }
    
    .calendar-day.completion-low {
      background: linear-gradient(135deg, #E74C3C 0%, #C0392B 100%);
      color: white;
      border-color: #E74C3C;
    }
    
    .calendar-day.completion-medium {
      background: linear-gradient(135deg, #F39C12 0%, #E67E22 100%);
      color: white;
      border-color: #F39C12;
    }
    
    .calendar-day.completion-high {
      background: linear-gradient(135deg, #5BA883 0%, #7DBEAA 100%);
      color: white;
      border-color: #5BA883;
    }
    
    .calendar-day:not(.empty):not(.future):hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 10;
    }
    
    .day-number {
      font-weight: 600;
      font-size: 1em;
    }
    
    .day-completion {
      font-size: 0.75em;
      font-weight: 600;
      text-align: center;
      padding: 4px 6px;
      border-radius: 6px;
      background: rgba(255,255,255,0.9);
      color: var(--text-primary);
    }
    
    .calendar-day.completion-low .day-completion,
    .calendar-day.completion-medium .day-completion,
    .calendar-day.completion-high .day-completion {
      background: rgba(255,255,255,0.25);
      color: white;
      font-weight: 700;
    }
    
    .day-indicators {
      display: flex;
      gap: 3px;
      margin-top: 4px;
      justify-content: center;
    }
    
    .day-indicator-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }
    
    .day-indicator-dot.reflection {
      background: #3498DB;
    }
    
    .day-indicator-dot.grace {
      background: #F39C12;
    }
    
    /* Reflection Modal Styles */
    .reflection-modal {
      max-width: 700px;
    }
    
    .reflection-questions {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin: 24px 0;
    }
    
    .question-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .question-group label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9375em;
    }
    
    .question-group textarea {
      padding: 12px;
      border: 1px solid var(--separator);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9375em;
      resize: vertical;
      min-height: 80px;
      background: var(--bg-primary);
    }
    
    .question-group input[type="text"] {
      padding: 12px;
      border: 1px solid var(--separator);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9375em;
      background: var(--bg-primary);
    }
    
    .question-group input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--separator);
      outline: none;
    }
    
    .question-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
    }
    
    .question-group input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-primary);
      cursor: pointer;
      border: none;
    }
    
    .feeling-scale {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875em;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    
    .feeling-value {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--accent-primary);
      text-align: center;
      margin: 8px 0;
    }
    
    .reflection-view {
      max-width: 700px;
    }
    
    .reflection-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin: 24px 0;
    }
    
    .reflection-section {
      background: var(--bg-secondary);
      padding: 16px;
      border-radius: 10px;
      border-left: 4px solid var(--accent-primary);
    }
    
    .reflection-section h3 {
      font-size: 1em;
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 8px;
    }
    
    .reflection-section p {
      color: var(--text-primary);
      line-height: 1.6;
      margin: 0;
    }
    
    .feeling-indicator {
      height: 32px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      transition: width 0.3s ease-out;
    }
    
    .completion-badge {
      display: inline-block;
      padding: 8px 16px;
      background: var(--accent-primary);
      color: white;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.875em;
      margin-bottom: 16px;
    }
    
    /* Task Editor Styles */
    .task-editor {
      max-width: 900px;
    }
    
    .task-categories-editor {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin: 24px 0;
    }
    
    .category-editor {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--separator);
    }
    
    .category-editor h3 {
      margin: 0 0 16px 0;
      color: var(--text-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .task-list-editor {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .editable-task-item {
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 8px;
      display: grid;
      grid-template-columns: 24px 100px 1fr 32px;
      gap: 12px;
      align-items: center;
      border: 1px solid var(--separator);
    }
    
    .drag-handle {
      cursor: move;
      color: var(--text-tertiary);
      font-size: 1.125em;
      user-select: none;
    }
    
    .editable-task-item input[type="time"] {
      padding: 6px 8px;
      border: 1px solid var(--separator);
      border-radius: 4px;
      font-size: 0.875em;
      font-family: inherit;
      background: white;
    }
    
    .editable-task-item input[type="text"] {
      padding: 8px;
      border: 1px solid var(--separator);
      border-radius: 4px;
      font-size: 0.9375em;
      flex: 1;
      font-family: inherit;
      background: white;
    }
    
    .task-delete-btn {
      background: transparent;
      border: none;
      color: #E74C3C;
      font-size: 1.25em;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .task-delete-btn:hover {
      background: #E74C3C;
      color: white;
    }
    
    .add-task-btn {
      background: var(--bg-primary);
      border: 2px dashed var(--separator);
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      font-weight: 600;
      transition: all 0.2s;
      text-align: center;
      width: 100%;
      font-family: inherit;
      font-size: 0.9375em;
    }
    
    .add-task-btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: var(--accent-light);
    }
    
    .task-editor-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--separator);
    }
    
    .task-editor-actions button {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--separator);
      background: var(--bg-secondary);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .task-editor-actions button:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }
    
    /* Day Detail Modal */
    .day-detail-modal {
      max-width: 800px;
    }
    
    .day-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .day-detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    
    .stat-mini {
      background: var(--bg-secondary);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-mini-label {
      font-size: 0.75em;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    
    .stat-mini-value {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--accent-primary);
    }
    
    .day-tasks-list {
      margin: 20px 0;
    }
    
    .day-task-category {
      margin-bottom: 20px;
    }
    
    .day-task-category h4 {
      font-size: 1em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--separator);
    }
    
    .day-task-item {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 6px;
      background: var(--bg-secondary);
    }
    
    .day-task-item.completed {
      opacity: 0.7;
      text-decoration: line-through;
    }
    
    .day-task-item .task-check {
      margin-right: 12px;
      font-size: 1.25em;
    }
    
    /* Weekly Summary Styles */
    .summary-section {
      background: var(--bg-secondary);
      padding: 20px;
      border-radius: 12px;
      margin: 16px 0;
    }
    
    .summary-section h3 {
      font-size: 1.125em;
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 12px;
    }
    
    .summary-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }
    
    .summary-stat {
      background: white;
      padding: 16px;
      border-radius: 10px;
      border-left: 4px solid var(--accent-primary);
    }
    
    .summary-stat-label {
      font-size: 0.875em;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .summary-stat-value {
      font-size: 1.75em;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .summary-stat-change {
      font-size: 0.875em;
      margin-top: 4px;
    }
    
    .summary-stat-change.positive {
      color: var(--accent-success);
    }
    
    .summary-stat-change.negative {
      color: #E74C3C;
    }
    
    .recommendation-item {
      background: white;
      padding: 16px;
      border-radius: 10px;
      margin: 12px 0;
      border-left: 4px solid var(--accent-teal);
    }
    
    .recommendation-item h4 {
      font-size: 1em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .recommendation-item p {
      font-size: 0.9375em;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0;
    }
    
    .resource-item {
      background: white;
      padding: 14px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--separator);
    }
    
    .resource-info {
      flex: 1;
    }
    
    .resource-type {
      font-size: 0.75em;
      text-transform: uppercase;
      color: var(--text-tertiary);
      font-weight: 600;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }
    
    .resource-title {
      font-size: 0.9375em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    
    .resource-relevance {
      font-size: 0.875em;
      color: var(--text-secondary);
    }
    
    .resource-link {
      background: var(--accent-primary);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875em;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .resource-link:hover {
      background: var(--accent-secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    /* Mobile Responsiveness for v2 */
    @media (max-width: 768px) {
      .calendar-grid {
        gap: 4px;
      }
      
      .calendar-day {
        padding: 6px 4px;
        min-height: 60px;
      }
      
      .day-number {
        font-size: 0.875em;
      }
      
      .day-completion {
        font-size: 0.625em;
        padding: 2px 4px;
      }
      
      .calendar-header-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .calendar-nav {
        justify-content: center;
      }
      
      .editable-task-item {
        grid-template-columns: 20px 80px 1fr 28px;
        gap: 8px;
      }
      
      .task-editor-actions {
        grid-template-columns: 1fr;
      }
      
      .summary-stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-icon">
          <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="40" height="40" rx="8" fill="#D97757"/>
            <circle cx="14" cy="14" r="2.5" fill="white"/>
            <circle cx="24" cy="14" r="2.5" fill="white"/>
            <circle cx="34" cy="14" r="2.5" fill="white"/>
            <circle cx="14" cy="24" r="2.5" fill="white"/>
            <circle cx="24" cy="24" r="2.5" fill="white"/>
            <circle cx="34" cy="24" r="2.5" fill="white"/>
            <circle cx="14" cy="34" r="2.5" fill="white"/>
            <circle cx="24" cy="34" r="2.5" fill="white"/>
            <circle cx="34" cy="34" r="2.5" fill="white"/>
          </svg>
        </div>
        <div class="logo-text">
          <h1>GC STRIDE</h1>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="calendarBtn">ðŸ“… Calendar</button>
      <button class="btn" id="healthBtn">Health Monitor</button>
      <button class="btn" id="weeklySummaryBtn">ðŸ“§ Weekly Summary</button>
      <button class="btn" id="helpBtn">Help</button>
      <button class="btn" id="settingsBtn">Settings</button>
      <button class="btn" id="toggleViewBtn">Toggle View</button>
      <button class="btn" id="weeklyReportBtn">Weekly Report</button>
      <button class="btn btn-primary" id="graceDayBtn">Use Grace Day</button>
    </div>

    <div id="vacationBanner" class="vacation-banner" style="display: none;">
      ðŸ–ï¸ VACATION MODE ACTIVE - Enjoy your break! Progress tracking paused. ðŸ–ï¸
    </div>

    <div id="graceBanner" class="grace-day-banner" style="display: none;">
      âœ¨ Grace Day Active! Today counts as 100% complete. âœ¨
    </div>

    <div id="rewardBanner" class="reward-banner" style="display: none;"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Week Progress</h3>
        <div class="stat-value" id="weekProgress">0%</div>
        <div class="progress-bar">
          <span class="progress-percentage" id="weekPercentage">0%</span>
          <div class="progress-fill" id="weekProgressBar" style="width: 0%;"></div>
        </div>
      </div>

      <div class="stat-card">
        <h3>Daily Progress</h3>
        <div class="stat-value" id="dailyProgress">0%</div>
        <div class="progress-bar">
          <span class="progress-percentage" id="dailyPercentage">0%</span>
          <div class="progress-fill" id="dailyProgressBar" style="width: 0%;"></div>
        </div>
      </div>

      <div class="stat-card hero">
        <h3>GC Trip Fund</h3>
        <div class="stat-value" id="fundAmount">$0</div>
        <div class="progress-bar">
          <span class="progress-percentage" id="fundPercentage">0%</span>
          <div class="progress-fill" id="fundProgressBar" style="width: 0%;"></div>
        </div>
        <small>Goal: $<span id="fundGoalDisplay">5000</span></small>
        <div class="milestones">
          <span class="milestone" data-amount="1250">$1,250</span>
          <span class="milestone" data-amount="2500">$2,500</span>
          <span class="milestone" data-amount="3750">$3,750</span>
          <span class="milestone" data-amount="5000">$5,000</span>
        </div>
      </div>

      <div class="stat-card">
        <h3>Current Streak</h3>
        <div class="stat-value" id="streakCount">0 days</div>
        <small id="streakMessage">Keep going!</small>
      </div>
    </div>

    <div class="quick-log-grid">
      <button class="quick-log-btn" onclick="quickLog('morning')">Morning Routine</button>
      <button class="quick-log-btn" onclick="quickLog('midday')">Midday Break</button>
      <button class="quick-log-btn" onclick="quickLog('afternoon')">Afternoon Reset</button>
      <button class="quick-log-btn" onclick="quickLog('evening')">Evening Routine</button>
    </div>

    <div id="fullView">
      <div class="section">
        <h2>Daily Checklist</h2>
        <div id="checklistContainer"></div>
      </div>

      <div class="section">
        <h2>Daily Tracking</h2>
        
        <div class="tracker-input">
          <label for="energySlider">Energy Level (1-10)</label>
          <input type="range" id="energySlider" min="1" max="10" value="5">
          <div class="slider-value" id="energyValue">5</div>
        </div>

        <div class="tracker-input">
          <label for="anxietySlider">Anxiety Level (1-10)</label>
          <input type="range" id="anxietySlider" min="1" max="10" value="5">
          <div class="slider-value" id="anxietyValue">5</div>
        </div>

        <div class="tracker-input">
          <label for="sleepInput">Apple Watch Sleep Hours</label>
          <input type="number" id="sleepInput" placeholder="7.5" step="0.5" min="0" max="12">
        </div>

        <div class="tracker-input">
          <label for="zwiftInput">Zwift Minutes</label>
          <input type="number" id="zwiftInput" placeholder="30" min="0">
        </div>

        <div class="tracker-input">
          <label for="yogaInput">Yoga Minutes</label>
          <input type="number" id="yogaInput" placeholder="20" min="0">
        </div>

        <div class="tracker-input">
          <label for="notesInput">Daily Notes</label>
          <textarea id="notesInput" placeholder="How are you feeling today? Any thoughts to capture?"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar View -->
  <div id="calendarView" class="calendar-view">
    <div class="calendar-header-controls">
      <h2>ðŸ“… Progress Calendar</h2>
      <div class="calendar-nav">
        <button onclick="previousMonth()">â† Prev</button>
        <span class="calendar-month-year" id="calendarMonthYear">January 2026</span>
        <button onclick="nextMonth()">Next â†’</button>
        <button onclick="goToToday()">Today</button>
      </div>
    </div>
    <div id="calendarContainer"></div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeHelp()">&times;</span>
      <h2 style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; color: var(--text-primary); margin-bottom: 24px; font-weight: 600; font-size: 1.5em; letter-spacing: 0.009em;">How to Use GC Stride</h2>
      
      <div class="help-section">
        <h3>ðŸŽ¯ The Goal</h3>
        <p>Complete <strong>75% of your weekly tasks</strong> to unlock 100% of your $5,000 trip fund!</p>
        <ul>
          <li>75% weekly completion = Weekend reading time bonus ðŸ“š</li>
          <li>80% weekly completion = Movie/documentary choice ðŸŽ¬</li>
          <li>Track consistently to build toward your trip goal!</li>
        </ul>
      </div>

      <div class="help-section">
        <h3>âš¡ Quick-Log Buttons</h3>
        <p>Save time by checking off entire routines at once:</p>
        <ul>
          <li><strong>Morning Routine</strong> = 6 items (brushing teeth, sunlight, supplements, etc.)</li>
          <li><strong>Midday Break</strong> = 3 items (walk, yoga, kettlebell)</li>
          <li><strong>Afternoon Reset</strong> = 2 items (breathing, walk)</li>
          <li><strong>Evening Routine</strong> = 6 items (movement, supplements, shower, etc.)</li>
        </ul>
      </div>

      <div class="help-section">
        <h3>ðŸ“Š Daily Tracking</h3>
        <p>Input your data in these simple fields:</p>
        <ul>
          <li><strong>Energy & Anxiety</strong>: Drag the sliders (1 = low, 10 = high)</li>
          <li><strong>Sleep Hours</strong>: Enter number from Apple Watch (e.g., "7.5")</li>
          <li><strong>Zwift Minutes</strong>: Enter cycling time (e.g., "30")</li>
          <li><strong>Yoga Minutes</strong>: Enter practice time (e.g., "20")</li>
          <li><strong>Notes</strong>: Optional daily reflections</li>
        </ul>
      </div>

      <div class="help-section">
        <h3>ðŸŒŸ Grace Day</h3>
        <p>Get <strong>1 free pass per week</strong> (resets Sunday)!</p>
        <ul>
          <li>Click "Use Grace Day" button to count today as 100% complete</li>
          <li>Perfect for sick days, busy days, or just needing a break</li>
          <li>Keeps your streak alive without the guilt!</li>
        </ul>
      </div>

      <div class="help-section">
        <h3>âš¡/ðŸ“‹ Simple vs Full View</h3>
        <p>Toggle between views based on your day:</p>
        <ul>
          <li><strong>Simple View</strong>: Just quick-log buttons and trackers (for overwhelming days)</li>
          <li><strong>Full View</strong>: Complete checklist visible (for detail-oriented days)</li>
        </ul>
      </div>

      <div class="help-section">
        <h3>âš™ï¸ Settings & Customization</h3>
        <ul>
          <li><strong>Adjust Times</strong>: Change when routines happen</li>
          <li><strong>Edit Checklist Items</strong>: Add, remove, or modify tasks</li>
          <li><strong>Vacation Mode</strong>: Pause tracking during breaks</li>
          <li><strong>Email Reports</strong>: Get weekly summaries sent to you</li>
        </ul>
      </div>
      
      <div class="help-section">
        <h3>âŒ¨ï¸ Keyboard Shortcuts</h3>
        <p>Power user shortcuts for faster navigation:</p>
        <ul>
          <li><strong>Cmd/Ctrl + 1</strong>: Quick-log Morning Routine</li>
          <li><strong>Cmd/Ctrl + 2</strong>: Quick-log Midday Break</li>
          <li><strong>Cmd/Ctrl + 3</strong>: Quick-log Afternoon Reset</li>
          <li><strong>Cmd/Ctrl + 4</strong>: Quick-log Evening Routine</li>
          <li><strong>Cmd/Ctrl + Z</strong>: Undo last action</li>
          <li><strong>Cmd/Ctrl + H</strong>: Open Help</li>
          <li><strong>Cmd/Ctrl + ,</strong>: Open Settings</li>
          <li><strong>Escape</strong>: Close any modal</li>
        </ul>
      </div>

      <button class="btn btn-primary" onclick="closeHelp()" style="margin-top: 20px; width: 100%;">Let's Start! ðŸš€</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeSettings()">&times;</span>
      <h2 style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; color: var(--text-primary); margin-bottom: 24px; font-weight: 600; font-size: 1.5em; letter-spacing: 0.009em;">Settings</h2>
      
      <div class="settings-grid">
        <div class="setting-item">
          <h4>âŒš Apple Watch Integration</h4>
          <p>Automatically sync sleep data from your Apple Watch</p>
          <div id="watchIntegrationStatus">
            <!-- Will be populated by JavaScript -->
          </div>
          <button class="btn btn-primary" onclick="openWatchSetup()" style="width: 100%; margin-top: 12px;">
            âš™ï¸ Configure Apple Watch
          </button>
          <button class="btn" onclick="testWatchSync()" style="width: 100%; margin-top: 8px; font-size: 0.875em;">
            ðŸ§ª Test Sync (Demo)
          </button>
        </div>
        
        <div class="setting-item">
          <h4>ðŸ“§ Weekly Email Reports</h4>
          <p>Get a summary of your week every Sunday</p>
          <div class="tracker-input">
            <label for="emailInput">Email Address</label>
            <input type="email" id="emailInput" placeholder="laura@example.com">
          </div>
          <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
            <input type="checkbox" id="emailReportsEnabled" style="width: 20px; height: 20px;">
            Enable weekly email reports
          </label>
        </div>

        <div class="setting-item">
          <h4>ðŸ–ï¸ Vacation Mode</h4>
          <p>Pause tracking during breaks without losing your streak</p>
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="vacationMode" onchange="toggleVacation()" style="width: 20px; height: 20px;">
            Activate vacation mode
          </label>
        </div>

        <div class="setting-item">
          <h4>â° Routine Times</h4>
          <p>Customize when each routine happens</p>
          <div class="time-inputs">
            <div>
              <label>Morning Start:</label>
              <input type="time" id="morningTime" value="06:45">
            </div>
            <div>
              <label>Midday Start:</label>
              <input type="time" id="middayTime" value="10:00">
            </div>
            <div>
              <label>Afternoon Start:</label>
              <input type="time" id="afternoonTime" value="15:00">
            </div>
            <div>
              <label>Evening Start:</label>
              <input type="time" id="eveningTime" value="18:00">
            </div>
          </div>
        </div>

        <div class="setting-item">
          <h4>âœï¸ Customize Checklist Items</h4>
          <p>Add, edit, or remove tasks to fit your needs</p>
          <div id="editableChecklists"></div>
          <button class="btn" onclick="resetToDefaults()" style="margin-top: 15px;">Reset to Defaults</button>
        </div>

        <div class="setting-item">
          <h4>GC Trip Fund Goal</h4>
          <p>Adjust your trip goal</p>
          <div class="tracker-input">
            <label for="fundGoalInput">Goal Amount ($)</label>
            <input type="number" id="fundGoalInput" value="5000" min="1000" step="100">
          </div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 30px; width: 100%;">Save Settings âœ“</button>
    </div>
  </div>

  <!-- Weekly Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeReport()">&times;</span>
      <h2 style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; color: var(--text-primary); margin-bottom: 24px; font-weight: 600; font-size: 1.5em; letter-spacing: 0.009em;">Weekly Report</h2>
      <div id="reportContent"></div>
      <button class="btn btn-primary" onclick="emailReport()" style="margin-top: 20px; width: 100%;">ðŸ“§ Email This Report</button>
    </div>
  </div>

  <!-- Reflection Modal -->
  <div id="reflectionModal" class="modal">
    <div class="modal-content reflection-modal">
      <span class="modal-close" onclick="closeReflectionModal()">&times;</span>
      <h2 id="reflectionDate">Daily Reflection</h2>
      
      <div class="reflection-questions">
        <div class="question-group">
          <label for="overallFeeling">How do you feel about today? (1-10)</label>
          <input type="range" id="overallFeeling" min="1" max="10" value="5" oninput="updateFeelingValue()">
          <div class="feeling-scale">
            <span>ðŸ˜” Low</span>
            <span class="feeling-value" id="feelingValue">5</span>
            <span>ðŸ˜Š High</span>
          </div>
        </div>
        
        <div class="question-group">
          <label for="wentWell">What went well today?</label>
          <textarea id="wentWell" placeholder="Celebrate your wins..."></textarea>
        </div>
        
        <div class="question-group">
          <label for="toImprove">What could be improved?</label>
          <textarea id="toImprove" placeholder="No judgment, just awareness..."></textarea>
        </div>
        
        <div class="question-group">
          <label for="keyInsight">Key insight or learning?</label>
          <textarea id="keyInsight" placeholder="Any patterns or realizations?" style="min-height: 60px;"></textarea>
        </div>
        
        <div class="question-group">
          <label for="tomorrowIntention">Tomorrow's intention:</label>
          <input type="text" id="tomorrowIntention" placeholder="One thing to focus on tomorrow...">
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="btn" onclick="skipReflection()">Skip</button>
        <button class="btn btn-primary" onclick="saveReflection()">Save Reflection</button>
      </div>
    </div>
  </div>

  <!-- Day Detail Modal -->
  <div id="dayDetailModal" class="modal">
    <div class="modal-content day-detail-modal">
      <span class="modal-close" onclick="closeDayDetail()">&times;</span>
      <div class="day-detail-header">
        <h2 id="dayDetailDate">Day Details</h2>
        <div class="completion-badge" id="dayDetailCompletion">0%</div>
      </div>
      
      <div class="day-detail-stats" id="dayDetailStats"></div>
      
      <div class="day-tasks-list" id="dayTasksList"></div>
      
      <div id="dayReflectionView"></div>
      
      <div class="modal-actions">
        <button class="btn" onclick="openReflectionForDay()">ðŸ“ Add/Edit Reflection</button>
        <button class="btn" onclick="openTaskEditorForDay()">âœï¸ Edit Tasks</button>
        <button class="btn btn-primary" onclick="closeDayDetail()">Close</button>
      </div>
    </div>
  </div>

  <!-- Task Editor Modal -->
  <div id="taskEditorModal" class="modal">
    <div class="modal-content task-editor">
      <span class="modal-close" onclick="closeTaskEditor()">&times;</span>
      <h2 id="taskEditorDate">Edit Tasks</h2>
      
      <div class="task-categories-editor" id="taskEditorContent"></div>
      
      <div class="task-editor-actions">
        <button onclick="resetToDefaultTasks()">ðŸ”„ Reset to Default</button>
        <button onclick="saveAsTemplate()">ðŸ’¾ Save as Template</button>
        <button onclick="applyToDateRange()">ðŸ“… Apply to Range</button>
        <button class="btn btn-primary" onclick="saveCustomTasks()">âœ… Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Weekly Summary Modal -->
  <div id="weeklySummaryModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <span class="modal-close" onclick="closeWeeklySummary()">&times;</span>
      <h2>ðŸ“§ Weekly Wellness Summary</h2>
      <p style="color: var(--text-secondary); margin-bottom: 24px;">
        Your personalized insights for the week
      </p>
      
      <div id="weeklySummaryContent"></div>
      
      <div class="modal-actions" style="margin-top: 24px;">
        <button class="btn" onclick="copyWeeklySummary()">ðŸ“‹ Copy to Clipboard</button>
        <button class="btn btn-primary" onclick="emailWeeklySummary()">ðŸ“§ Email Myself</button>
      </div>
    </div>
  </div>

  <!-- Apple Watch Onboarding Modal -->
  <div id="onboardingModal" class="onboarding-modal">
    <div class="onboarding-content">
      <!-- Step 1: Welcome -->
      <div class="onboarding-step active" data-step="1">
        <div class="onboarding-header">
          <div class="watch-icon">âŒš</div>
          <h2>Connect Your Apple Watch</h2>
          <p>Automatically sync sleep data and make tracking effortless</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot active"></span>
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot"></span>
        </div>
        
        <p style="text-align: center; color: var(--text-secondary); margin: 24px 0;">
          Choose how you'd like to sync your Apple Watch sleep data with GC Stride
        </p>
        
        <div class="onboarding-actions">
          <button class="btn" onclick="skipOnboarding()">Skip for Now</button>
          <button class="btn btn-primary" onclick="nextOnboardingStep()">Get Started</button>
        </div>
      </div>
      
      <!-- Step 2: Choose Method -->
      <div class="onboarding-step" data-step="2">
        <div class="onboarding-header">
          <h2>Choose Sync Method</h2>
          <p>Pick the option that works best for you</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span class="step-dot active"></span>
          <span class="step-dot"></span>
          <span class="step-dot"></span>
        </div>
        
        <div class="integration-option" onclick="selectIntegration('healthauto')" id="option-healthauto">
          <h3>
            <span>ðŸ“±</span>
            Health Auto Export
            <span class="badge recommended">RECOMMENDED</span>
          </h3>
          <p><strong>$2.99/month</strong> - Fully automatic sync via iPhone app. Set it once, never think about it again. Perfect for daily use.</p>
        </div>
        
        <div class="integration-option" onclick="selectIntegration('shortcuts')" id="option-shortcuts">
          <h3>
            <span>âš¡</span>
            Apple Shortcuts
            <span class="badge">FREE</span>
          </h3>
          <p>One-tap sync using iOS Shortcuts. Requires daily manual trigger, but completely free. Great for tech-savvy users.</p>
        </div>
        
        <div class="integration-option" onclick="selectIntegration('manual')" id="option-manual">
          <h3>
            <span>âœï¸</span>
            Manual Entry
            <span class="badge manual">BASIC</span>
          </h3>
          <p>Check your Apple Watch sleep data and enter it manually each day. No setup required.</p>
        </div>
        
        <div class="onboarding-actions">
          <button class="btn" onclick="prevOnboardingStep()">Back</button>
          <button class="btn btn-primary" onclick="nextOnboardingStep()" id="continueBtn" disabled>Continue</button>
        </div>
      </div>
      
      <!-- Step 3: Health Auto Export Setup -->
      <div class="onboarding-step" data-step="3-healthauto">
        <div class="onboarding-header">
          <h2>Health Auto Export Setup</h2>
          <p>Follow these steps to enable automatic sync</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot active"></span>
          <span class="step-dot"></span>
        </div>
        
        <div class="instruction-list">
          <ol style="color: var(--text-primary); line-height: 1.8;">
            <li><strong>Download the app</strong> from the App Store:<br>
            <a href="https://apps.apple.com/app/health-auto-export/id1115567069" target="_blank" style="color: var(--accent-primary);">Health Auto Export - JSON+CSV</a></li>
            <li><strong>Open the app</strong> and tap "Automations"</li>
            <li><strong>Create new automation</strong> for "Sleep Analysis"</li>
            <li><strong>Set trigger</strong>: Daily at 8:00 AM</li>
            <li><strong>Choose export method</strong>: Webhook/URL</li>
            <li><strong>Enter this webhook URL</strong>:</li>
          </ol>
        </div>
        
        <div class="code-block" id="webhookUrl">
          https://gcstride.app/api/sync/[YOUR-USER-ID]
        </div>
        
        <button class="btn" onclick="copyWebhookUrl()" style="width: 100%; margin-bottom: 16px;">ðŸ“‹ Copy Webhook URL</button>
        
        <div class="connection-status">
          <div class="status-indicator" id="connectionStatus"></div>
          <span style="color: var(--text-secondary);">Waiting for first sync...</span>
        </div>
        
        <div class="onboarding-actions">
          <button class="btn" onclick="prevOnboardingStep()">Back</button>
          <button class="btn btn-primary" onclick="completeOnboarding()">Done</button>
        </div>
      </div>
      
      <!-- Step 3: Shortcuts Setup -->
      <div class="onboarding-step" data-step="3-shortcuts">
        <div class="onboarding-header">
          <h2>Apple Shortcuts Setup</h2>
          <p>Set up one-tap sync with iOS Shortcuts</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot active"></span>
          <span class="step-dot"></span>
        </div>
        
        <div class="instruction-list">
          <ol style="color: var(--text-primary); line-height: 1.8;">
            <li><strong>Download our pre-made shortcut</strong>:<br>
            <button class="btn btn-primary" onclick="downloadShortcut()" style="margin-top: 8px;">â¬‡ï¸ Download GC Stride Sync Shortcut</button></li>
            <li><strong>Open the Shortcuts app</strong> and find "GC Stride Sync"</li>
            <li><strong>Tap the shortcut</strong> once per day (morning recommended)</li>
            <li><strong>Grant Health access</strong> when prompted</li>
            <li><strong>Optional</strong>: Add to home screen for quick access</li>
          </ol>
        </div>
        
        <div style="background: var(--accent-light); border-radius: 10px; padding: 16px; margin: 16px 0;">
          <p style="color: var(--text-primary); font-size: 0.9375em; line-height: 1.6;">
            ðŸ’¡ <strong>Pro Tip:</strong> Set a daily reminder at 8 AM to run the shortcut. It only takes 2 seconds!
          </p>
        </div>
        
        <div class="onboarding-actions">
          <button class="btn" onclick="prevOnboardingStep()">Back</button>
          <button class="btn btn-primary" onclick="completeOnboarding()">Done</button>
        </div>
      </div>
      
      <!-- Step 3: Manual Entry -->
      <div class="onboarding-step" data-step="3-manual">
        <div class="onboarding-header">
          <h2>Manual Entry</h2>
          <p>How to check your sleep data</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot active"></span>
          <span class="step-dot"></span>
        </div>
        
        <div class="instruction-list">
          <ol style="color: var(--text-primary); line-height: 1.8;">
            <li><strong>Open the Health app</strong> on your iPhone</li>
            <li><strong>Tap "Browse"</strong> at the bottom</li>
            <li><strong>Select "Sleep"</strong></li>
            <li><strong>View today's sleep hours</strong></li>
            <li><strong>Enter the number</strong> in the GC Stride sleep field</li>
          </ol>
        </div>
        
        <div style="background: var(--bg-primary); border-radius: 10px; padding: 16px; margin: 16px 0; text-align: center;">
          <p style="color: var(--text-secondary); font-size: 0.875em; margin-bottom: 12px;">Example:</p>
          <p style="font-size: 2em; font-weight: 600; color: var(--accent-primary);">7.5</p>
          <p style="color: var(--text-secondary); font-size: 0.875em; margin-top: 8px;">hours of sleep</p>
        </div>
        
        <div class="onboarding-actions">
          <button class="btn" onclick="prevOnboardingStep()">Back</button>
          <button class="btn btn-primary" onclick="completeOnboarding()">Got It!</button>
        </div>
      </div>
      
      <!-- Step 4: Complete -->
      <div class="onboarding-step" data-step="4">
        <div class="onboarding-header">
          <div class="watch-icon">âœ…</div>
          <h2>You're All Set!</h2>
          <p>Start tracking your wellness journey</p>
        </div>
        
        <div class="step-indicator">
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot"></span>
          <span class="step-dot active"></span>
        </div>
        
        <div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
          <p style="font-size: 1.125em; color: var(--text-primary); line-height: 1.6;">
            Your Apple Watch is now connected! Sleep data will sync automatically based on your chosen method.
          </p>
        </div>
        
        <div class="onboarding-actions">
          <button class="btn btn-primary" onclick="completeOnboarding()" style="flex: 1;">Start Tracking ðŸš€</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Health Monitoring Modal -->
  <div id="healthModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
      <span class="modal-close" onclick="closeHealth()">&times;</span>
      <h2 style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; color: var(--text-primary); margin-bottom: 8px; font-weight: 600; font-size: 1.75em; letter-spacing: 0.009em;">Health Monitoring</h2>
      <p style="color: var(--text-secondary); margin-bottom: 32px;">Comprehensive biomarker tracking and health data analysis</p>
      
      <!-- Health Nav Tabs -->
      <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 2px solid var(--separator); overflow-x: auto;">
        <button class="health-tab active" onclick="switchHealthTab('vitals')">âŒš Vitals</button>
        <button class="health-tab" onclick="switchHealthTab('labs')">ðŸ§ª Lab Results</button>
        <button class="health-tab" onclick="switchHealthTab('symptoms')">ðŸ“ Symptoms</button>
        <button class="health-tab" onclick="switchHealthTab('meds')">ðŸ’Š Medications</button>
        <button class="health-tab" onclick="switchHealthTab('custom')">ðŸ“Š Custom Metrics</button>
        <button class="health-tab" onclick="switchHealthTab('export')">ðŸ“¥ Export Data</button>
      </div>
      
      <!-- Vitals Tab -->
      <div id="health-tab-vitals" class="health-tab-content active">
        <h3 style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Apple Watch Vitals - Today</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <!-- Heart Rate Card -->
          <div class="stat-card">
            <h3>â¤ï¸ Heart Rate</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Resting</label>
                <input type="number" id="restingHR" placeholder="60" min="30" max="120" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">bpm</small>
              </div>
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Average</label>
                <input type="number" id="avgHR" placeholder="75" min="40" max="150" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">bpm</small>
              </div>
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Max</label>
                <input type="number" id="maxHR" placeholder="140" min="60" max="220" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">bpm</small>
              </div>
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Walking</label>
                <input type="number" id="walkingHR" placeholder="95" min="50" max="160" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">bpm</small>
              </div>
            </div>
          </div>
          
          <!-- HRV Card -->
          <div class="stat-card">
            <h3>ðŸ“ˆ Heart Rate Variability (HRV)</h3>
            <div style="margin-top: 16px;">
              <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">SDNN (ms)</label>
              <input type="number" id="hrvSDNN" placeholder="50" min="10" max="200" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
              <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Normal: 20-200ms | Higher = Better recovery</small>
            </div>
          </div>
          
          <!-- Blood Oxygen Card -->
          <div class="stat-card">
            <h3>ðŸ« Blood Oxygen (SpO2)</h3>
            <div style="margin-top: 16px;">
              <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Oxygen Saturation</label>
              <input type="number" id="spo2" placeholder="98" min="70" max="100" step="0.1" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
              <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">%</small>
            </div>
          </div>
          
          <!-- Blood Pressure Card -->
          <div class="stat-card">
            <h3>ðŸ©º Blood Pressure</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Systolic</label>
                <input type="number" id="systolic" placeholder="120" min="70" max="200" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">mmHg</small>
              </div>
              <div>
                <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Diastolic</label>
                <input type="number" id="diastolic" placeholder="80" min="40" max="130" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
                <small style="color: var(--text-tertiary);">mmHg</small>
              </div>
            </div>
            <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Normal: <120/80 mmHg</small>
          </div>
          
          <!-- Respiratory Rate Card -->
          <div class="stat-card">
            <h3>ðŸŒ¬ï¸ Respiratory Rate</h3>
            <div style="margin-top: 16px;">
              <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Breaths per Minute</label>
              <input type="number" id="respRate" placeholder="16" min="8" max="40" step="0.5" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
              <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Normal: 12-20 bpm</small>
            </div>
          </div>
          
          <!-- VO2 Max Card -->
          <div class="stat-card">
            <h3>ðŸƒ VO2 Max</h3>
            <div style="margin-top: 16px;">
              <label style="font-size: 0.75em; color: var(--text-tertiary); text-transform: uppercase;">Cardio Fitness</label>
              <input type="number" id="vo2max" placeholder="45" min="20" max="80" step="0.1" style="width: 100%; padding: 8px; margin-top: 4px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
              <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">mL/kg/min</small>
            </div>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <!-- Steps Card -->
          <div class="stat-card">
            <h3>ðŸ‘£ Steps</h3>
            <input type="number" id="steps" placeholder="10000" min="0" style="width: 100%; padding: 8px; margin-top: 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
            <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Daily step count</small>
          </div>
          
          <!-- Active Calories Card -->
          <div class="stat-card">
            <h3>ðŸ”¥ Active Calories</h3>
            <input type="number" id="activeCalories" placeholder="500" min="0" style="width: 100%; padding: 8px; margin-top: 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
            <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">kcal burned</small>
          </div>
          
          <!-- Exercise Minutes Card -->
          <div class="stat-card">
            <h3>â±ï¸ Exercise Minutes</h3>
            <input type="number" id="exerciseMins" placeholder="30" min="0" style="width: 100%; padding: 8px; margin-top: 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
            <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Active minutes</small>
          </div>
          
          <!-- Stand Hours Card -->
          <div class="stat-card">
            <h3>ðŸ§ Stand Hours</h3>
            <input type="number" id="standHours" placeholder="12" min="0" max="24" style="width: 100%; padding: 8px; margin-top: 12px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-primary);">
            <small style="color: var(--text-tertiary); display: block; margin-top: 8px;">Hours with â‰¥1 min standing</small>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="saveVitals()" style="width: 100%;">ðŸ’¾ Save Today's Vitals</button>
      </div>
      
      <!-- Labs Tab -->
      <div id="health-tab-labs" class="health-tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-weight: 600; color: var(--text-primary); margin: 0;">Lab Results & Biomarkers</h3>
          <button class="btn btn-primary" onclick="showAddLabModal()">+ Add Lab Result</button>
        </div>
        
        <div id="labsList" style="display: grid; gap: 12px;">
          <!-- Lab results will be populated here -->
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            <p>No lab results yet. Click "+ Add Lab Result" to start tracking.</p>
          </div>
        </div>
      </div>
      
      <!-- Symptoms Tab -->
      <div id="health-tab-symptoms" class="health-tab-content">
        <h3 style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Symptom Tracking</h3>
        
        <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Add Symptom</label>
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; align-items: end;">
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Symptom</label>
              <input type="text" id="symptomName" placeholder="e.g., Headache, Fatigue, Nausea" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Severity (1-10)</label>
              <input type="number" id="symptomSeverity" min="1" max="10" placeholder="5" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Time</label>
              <input type="time" id="symptomTime" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <button class="btn btn-primary" onclick="addSymptom()">Add</button>
          </div>
        </div>
        
        <div id="symptomsList">
          <!-- Symptoms will be populated here -->
        </div>
      </div>
      
      <!-- Medications Tab -->
      <div id="health-tab-meds" class="health-tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-weight: 600; color: var(--text-primary); margin: 0;">Medications & Supplements</h3>
          <button class="btn btn-primary" onclick="showAddMedModal()">+ Add Medication</button>
        </div>
        
        <div id="medsList">
          <!-- Medications will be populated here -->
        </div>
      </div>
      
      <!-- Custom Metrics Tab -->
      <div id="health-tab-custom" class="health-tab-content">
        <h3 style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Custom Health Metrics</h3>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Track any custom metrics like glucose levels, ketones, weight, body fat %, etc.</p>
        
        <div style="background: var(--bg-primary); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 12px; align-items: end;">
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Metric Name</label>
              <input type="text" id="customMetricName" placeholder="e.g., Glucose, Weight, Body Fat %" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Value</label>
              <input type="number" id="customMetricValue" placeholder="0" step="0.1" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <div>
              <label style="font-size: 0.875em; color: var(--text-secondary);">Unit</label>
              <input type="text" id="customMetricUnit" placeholder="mg/dL, kg, %" style="width: 100%; padding: 10px; border: 1px solid var(--separator); border-radius: 6px; background: var(--bg-secondary);">
            </div>
            <button class="btn btn-primary" onclick="addCustomMetric()">Add</button>
          </div>
        </div>
        
        <div id="customMetricsList">
          <!-- Custom metrics will be populated here -->
        </div>
      </div>
      
      <!-- Export Tab -->
      <div id="health-tab-export" class="health-tab-content">
        <h3 style="font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Export Health Data for Analysis</h3>
        <p style="color: var(--text-secondary); margin-bottom: 24px;">Download your complete health dataset for analysis in R, Python, or data visualization tools.</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
          <div class="stat-card">
            <h3>ðŸ“Š Complete Dataset (CSV)</h3>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 12px 0;">All vitals, labs, symptoms, and custom metrics in one CSV file.</p>
            <button class="btn btn-primary" onclick="exportCompleteHealthData()" style="width: 100%;">Download Complete CSV</button>
          </div>
          
          <div class="stat-card">
            <h3>ðŸ§¬ Biomarkers Only (CSV)</h3>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 12px 0;">Lab results and biomarker data for longitudinal analysis.</p>
            <button class="btn btn-primary" onclick="exportLabsData()" style="width: 100%;">Download Labs CSV</button>
          </div>
          
          <div class="stat-card">
            <h3>âŒš Apple Watch Data (CSV)</h3>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 12px 0;">Daily vitals from Apple Watch for trend analysis.</p>
            <button class="btn btn-primary" onclick="exportVitalsData()" style="width: 100%;">Download Vitals CSV</button>
          </div>
          
          <div class="stat-card">
            <h3>ðŸ“ˆ JSON Export</h3>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 12px 0;">Complete data structure in JSON format for programmatic access.</p>
            <button class="btn" onclick="exportHealthJSON()" style="width: 100%;">Download JSON</button>
          </div>
        </div>
        
        <div style="background: var(--accent-light); border-radius: 12px; padding: 20px; margin-top: 24px;">
          <h4 style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">ðŸ“Š Data Analysis Tips</h4>
          <ul style="color: var(--text-secondary); line-height: 1.8; margin-left: 20px;">
            <li><strong>Python/Pandas:</strong> Use pd.read_csv() to load and analyze trends</li>
            <li><strong>R:</strong> Load with read.csv() for statistical modeling</li>
            <li><strong>Excel:</strong> Import CSV for pivot tables and charts</li>
            <li><strong>Tableau/Power BI:</strong> Create interactive dashboards</li>
            <li><strong>Correlation Analysis:</strong> Compare HRV vs sleep quality, BP vs stress levels, etc.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Default checklist structure
    const defaultChecklist = {
      morning: [
        { time: '6:45 AM', text: 'Brush teeth', editable: true },
        { time: '7:00 AM', text: 'Sunlight & Hydration (15 acres + Baja Gold Salt)', editable: true },
        { time: '7:30 AM', text: 'Red Light Therapy + Yin Yoga (20 mins)', editable: true },
        { time: '7:50 AM', text: '30g Protein Shake (Whey + Creatine)', editable: true },
        { time: '8:00 AM', text: 'Morning Supplements (EAA, B12, D3/K2, Omega)', editable: true },
        { time: '8:00 AM', text: 'Deep Work Start', editable: true }
      ],
      midday: [
        { time: '10:00 AM', text: '10-min walk with Shepherd to pond', editable: true },
        { time: '12:00 PM', text: '15-min Vinyasa Yoga/Dog walk', editable: true },
        { time: '12:15 PM', text: '5-min Kettlebell Halos', editable: true }
      ],
      afternoon: [
        { time: '3:00 PM', text: '5 mins Box Breathing (4-4-4-4)', editable: true },
        { time: '3:05 PM', text: '5-min Dog Walk', editable: true }
      ],
      evening: [
        { time: '6:00 PM', text: '30-min Movement (Zwift Zone 2 or Kettlebell)', editable: true },
        { time: '7:00 PM', text: 'Evening Supplements (Beef Liver, Magnesium, Iron, Digestive Enzyme)', editable: true },
        { time: '8:30 PM', text: 'Phone in drawer (Digital Sunset)', editable: true },
        { time: '9:00 PM', text: 'Warm shower', editable: true },
        { time: '9:00 PM', text: 'Brush teeth', editable: true },
        { time: '9:15 PM', text: 'Reading time (Kindle Warmth Max)', editable: true }
      ]
    };

    // Initialize data structure
    let data = {
      checklist: JSON.parse(JSON.stringify(defaultChecklist)),
      dailyData: {},
      healthData: {
        // Daily vitals from Apple Watch
        vitals: {}, // { 'YYYY-MM-DD': { heartRate: {...}, hrv: {...}, bloodPressure: {...}, etc } }
        // Lab results and biomarkers
        labs: [], // [{ date, type, value, unit, range, notes }]
        // Symptoms tracking
        symptoms: {}, // { 'YYYY-MM-DD': [{ symptom, severity, time }] }
        // Medication tracking
        medications: [], // [{ name, dosage, frequency, startDate, endDate }]
        // Custom metrics
        customMetrics: {} // User-defined tracking
      },
      settings: {
        email: '',
        emailReportsEnabled: false,
        vacationMode: false,
        morningTime: '06:45',
        middayTime: '10:00',
        afternoonTime: '15:00',
        eveningTime: '18:00',
        fundGoal: 5000,
        watchIntegration: null, // null, 'healthauto', 'shortcuts', 'manual'
        watchConnected: false,
        watchLastSync: null
      },
      graceDaysUsed: [],
      streak: 0,
      lastVisit: null
    };

    // Load saved data
    function loadData() {
      const saved = localStorage.getItem('wellnessTrackerData');
      if (saved) {
        const parsed = JSON.parse(saved);
        data = { ...data, ...parsed };
        // Ensure checklist structure exists
        if (!data.checklist) {
          data.checklist = JSON.parse(JSON.stringify(defaultChecklist));
        }
      }
      
      // Show help on first visit
      if (!data.lastVisit) {
        document.getElementById('helpModal').style.display = 'block';
      }
      
      data.lastVisit = new Date().toISOString();
      saveData();
    }

    // Save data
    function saveData() {
      localStorage.setItem('wellnessTrackerData', JSON.stringify(data));
      updateDisplay();
    }

    // Get today's key
    function getTodayKey() {
      return new Date().toISOString().split('T')[0];
    }

    // Get current week key
    function getWeekKey() {
      const now = new Date();
      const day = now.getDay();
      const diff = now.getDate() - day;
      const sunday = new Date(now.setDate(diff));
      return sunday.toISOString().split('T')[0];
    }

    // Initialize today's data
    function initTodayData() {
      const today = getTodayKey();
      if (!data.dailyData[today]) {
        data.dailyData[today] = {
          completed: {},
          energy: 5,
          anxiety: 5,
          sleep: null,
          zwift: null,
          yoga: null,
          notes: '',
          graceDay: false
        };
      }
      return data.dailyData[today];
    }

    // Render checklist
    function renderChecklist() {
      const container = document.getElementById('checklistContainer');
      const todayData = initTodayData();
      
      container.innerHTML = '';
      
      const categories = [
        { key: 'morning', title: 'Morning Routine', emoji: '' },
        { key: 'midday', title: 'Midday Break', emoji: '' },
        { key: 'afternoon', title: 'Afternoon Reset', emoji: '' },
        { key: 'evening', title: 'Evening Routine', emoji: '' }
      ];
      
      categories.forEach(cat => {
        const categoryItems = data.checklist[cat.key];
        const completedCount = categoryItems.filter((item, idx) => 
          todayData.completed[`${cat.key}-${idx}`]
        ).length;
        const totalCount = categoryItems.length;
        const isComplete = completedCount === totalCount;
        
        const catDiv = document.createElement('div');
        catDiv.className = 'checklist-category';
        catDiv.innerHTML = `
          <h3 onclick="toggleCategory('${cat.key}')">
            <span>${cat.title}</span>
            <span class="category-count ${isComplete ? 'complete' : ''}">${completedCount}/${totalCount}</span>
            <span class="collapse-icon">â–¼</span>
          </h3>
        `;
        
        categoryItems.forEach((item, idx) => {
          const itemId = `${cat.key}-${idx}`;
          const isCompleted = todayData.completed[itemId] || false;
          
          const itemDiv = document.createElement('div');
          itemDiv.className = `checklist-item ${isCompleted ? 'completed' : ''}`;
          itemDiv.id = `item-${itemId}`;
          itemDiv.innerHTML = `
            <input type="checkbox" id="${itemId}" ${isCompleted ? 'checked' : ''} onchange="toggleItem('${itemId}', '${cat.emoji}', '${cat.key}')">
            <label for="${itemId}">
              <span class="time-label">${item.time}</span>
              ${item.text}
            </label>
          `;
          
          catDiv.appendChild(itemDiv);
        });
        
        container.appendChild(catDiv);
      });
      
      updateStats();
    }

    // Toggle category collapse
    function toggleCategory(categoryKey) {
      const categories = document.querySelectorAll('.checklist-category');
      categories.forEach(cat => {
        const header = cat.querySelector('h3');
        if (header && header.textContent.includes(getCategoryTitle(categoryKey))) {
          cat.classList.toggle('collapsed');
        }
      });
    }
    
    function getCategoryTitle(key) {
      const titles = {
        morning: 'Morning Routine',
        midday: 'Midday Break',
        afternoon: 'Afternoon Reset',
        evening: 'Evening Routine'
      };
      return titles[key] || '';
    }

    // Store last action for undo
    let lastAction = null;
    let undoTimeout = null;

    // Toggle checklist item
    function toggleItem(itemId, emoji, category) {
      const todayData = initTodayData();
      const previousState = todayData.completed[itemId];
      todayData.completed[itemId] = !todayData.completed[itemId];
      
      // Store for undo
      lastAction = {
        type: 'toggle',
        itemId: itemId,
        previousState: previousState
      };
      
      saveData();
      
      // Add animation
      const itemElement = document.getElementById(`item-${itemId}`);
      if (itemElement && todayData.completed[itemId]) {
        itemElement.classList.add('just-checked');
        setTimeout(() => itemElement.classList.remove('just-checked'), 600);
      }
      
      renderChecklist();
      showUndoToast('Item ' + (todayData.completed[itemId] ? 'checked' : 'unchecked'));
    }
    
    // Show undo toast
    function showUndoToast(message) {
      // Clear existing toast
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();
      if (undoTimeout) clearTimeout(undoTimeout);
      
      // Create toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `
        <span class="toast-message">${message}</span>
        <button class="toast-action" onclick="undoLastAction()">Undo</button>
      `;
      document.body.appendChild(toast);
      
      // Auto-hide after 4 seconds
      undoTimeout = setTimeout(() => {
        toast.remove();
        lastAction = null;
      }, 4000);
    }
    
    // Undo last action
    function undoLastAction() {
      if (!lastAction) return;
      
      const todayData = initTodayData();
      
      if (lastAction.type === 'toggle') {
        todayData.completed[lastAction.itemId] = lastAction.previousState;
      } else if (lastAction.type === 'quickLog') {
        lastAction.items.forEach(itemId => {
          todayData.completed[itemId] = lastAction.previousStates[itemId];
        });
      }
      
      saveData();
      renderChecklist();
      
      // Remove toast
      const toast = document.querySelector('.toast');
      if (toast) toast.remove();
      lastAction = null;
    }

    // Check if category is complete
    function isCategoryComplete(category) {
      const todayData = initTodayData();
      const categoryItems = data.checklist[category];
      
      for (let i = 0; i < categoryItems.length; i++) {
        const itemId = `${category}-${i}`;
        if (!todayData.completed[itemId]) return false;
      }
      return true;
    }

    // Quick log entire category
    function quickLog(category) {
      const todayData = initTodayData();
      const categoryItems = data.checklist[category];
      const previousStates = {};
      const itemIds = [];
      
      categoryItems.forEach((item, idx) => {
        const itemId = `${category}-${idx}`;
        previousStates[itemId] = todayData.completed[itemId] || false;
        todayData.completed[itemId] = true;
        itemIds.push(itemId);
      });
      
      // Store for undo
      lastAction = {
        type: 'quickLog',
        items: itemIds,
        previousStates: previousStates
      };
      
      saveData();
      renderChecklist();
      
      const categoryName = getCategoryTitle(category);
      showUndoToast(`${categoryName} completed!`);
      
      // Add confetti effect if all categories complete
      checkForMilestone();
    }

    // Calculate daily progress
    function calculateDailyProgress() {
      const todayData = initTodayData();
      
      if (todayData.graceDay) return 100;
      
      const totalItems = Object.values(data.checklist).reduce((sum, cat) => sum + cat.length, 0);
      const completedItems = Object.values(todayData.completed).filter(Boolean).length;
      
      return Math.round((completedItems / totalItems) * 100);
    }

    // Calculate week progress
    function calculateWeekProgress() {
      const weekKey = getWeekKey();
      const weekStart = new Date(weekKey);
      const today = new Date();
      
      let totalDays = 0;
      let completedDays = 0;
      
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(weekStart);
        checkDate.setDate(weekStart.getDate() + i);
        
        if (checkDate > today) break;
        
        totalDays++;
        const dateKey = checkDate.toISOString().split('T')[0];
        const dayData = data.dailyData[dateKey];
        
        if (dayData) {
          const dayProgress = calculateDayProgress(dateKey);
          if (dayProgress >= 75) completedDays++;
        }
      }
      
      return totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
    }

    // Calculate specific day progress
    function calculateDayProgress(dateKey) {
      const dayData = data.dailyData[dateKey];
      if (!dayData) return 0;
      if (dayData.graceDay) return 100;
      
      const totalItems = Object.values(data.checklist).reduce((sum, cat) => sum + cat.length, 0);
      const completedItems = Object.values(dayData.completed).filter(Boolean).length;
      
      return Math.round((completedItems / totalItems) * 100);
    }

    // Update display
    function updateDisplay() {
      const todayData = initTodayData();
      const dailyProgress = calculateDailyProgress();
      const weekProgress = calculateWeekProgress();
      
      // Update progress displays with percentages
      document.getElementById('dailyProgress').textContent = dailyProgress + '%';
      document.getElementById('dailyProgressBar').style.width = dailyProgress + '%';
      document.getElementById('dailyPercentage').textContent = dailyProgress + '%';
      
      document.getElementById('weekProgress').textContent = weekProgress + '%';
      document.getElementById('weekProgressBar').style.width = weekProgress + '%';
      document.getElementById('weekPercentage').textContent = weekProgress + '%';
      
      // Calculate fund with milestone achievements
      const fundAmount = Math.min(data.settings.fundGoal, (weekProgress / 100) * data.settings.fundGoal);
      document.getElementById('fundAmount').textContent = '$' + Math.round(fundAmount);
      const fundPercent = (fundAmount / data.settings.fundGoal) * 100;
      document.getElementById('fundProgressBar').style.width = fundPercent + '%';
      document.getElementById('fundPercentage').textContent = Math.round(fundPercent) + '%';
      document.getElementById('fundGoalDisplay').textContent = data.settings.fundGoal;
      
      // Update milestone badges
      updateMilestones(Math.round(fundAmount));
      
      // Check for milestone achievements and celebrate
      checkMilestoneAchievement(Math.round(fundAmount));
      
      // Update streak with message
      const streak = calculateStreak();
      document.getElementById('streakCount').textContent = streak + ' days';
      const streakMessage = document.getElementById('streakMessage');
      if (streakMessage) {
        if (streak === 0) streakMessage.textContent = 'Start your journey!';
        else if (streak < 7) streakMessage.textContent = 'Keep going!';
        else if (streak < 30) streakMessage.textContent = 'Great momentum! ðŸ”¥';
        else if (streak < 100) streakMessage.textContent = 'Unstoppable! ðŸ’ª';
        else streakMessage.textContent = 'Legendary streak! ðŸ†';
      }
      
      // Update trackers
      document.getElementById('energySlider').value = todayData.energy;
      document.getElementById('energyValue').textContent = todayData.energy;
      
      document.getElementById('anxietySlider').value = todayData.anxiety;
      document.getElementById('anxietyValue').textContent = todayData.anxiety;
      
      document.getElementById('sleepInput').value = todayData.sleep || '';
      document.getElementById('zwiftInput').value = todayData.zwift || '';
      document.getElementById('yogaInput').value = todayData.yoga || '';
      document.getElementById('notesInput').value = todayData.notes || '';
      
      // Show reward banner on weekends
      const now = new Date();
      const isWeekend = now.getDay() === 0 || now.getDay() === 6;
      const banner = document.getElementById('rewardBanner');
      
      if (isWeekend && weekProgress >= 75) {
        let html = '<h3>ðŸŽ‰ Weekend Rewards Unlocked! ðŸŽ‰</h3>';
        if (weekProgress >= 75) html += '<p>ðŸ“š Extra reading time earned!</p>';
        if (weekProgress >= 80) html += '<p>ðŸŽ¬ Movie/documentary choice earned!</p>';
        banner.innerHTML = html;
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
      
      // Grace day banner
      if (todayData.graceDay) {
        document.getElementById('graceBanner').style.display = 'block';
      } else {
        document.getElementById('graceBanner').style.display = 'none';
      }
      
      // Vacation banner
      if (data.settings.vacationMode) {
        document.getElementById('vacationBanner').style.display = 'block';
      } else {
        document.getElementById('vacationBanner').style.display = 'none';
      }
      
      // Update grace day button
      const weekKey = getWeekKey();
      const graceDaysThisWeek = data.graceDaysUsed.filter(d => d.startsWith(weekKey.substring(0, 7))).length;
      const graceDayBtn = document.getElementById('graceDayBtn');
      
      if (graceDaysThisWeek >= 1 || todayData.graceDay) {
        graceDayBtn.disabled = true;
        graceDayBtn.textContent = todayData.graceDay ? 'Grace Day Used' : 'No Grace Days Left';
      } else {
        graceDayBtn.disabled = false;
        graceDayBtn.textContent = 'Use Grace Day';
      }
    }
    
    // Update milestone badges
    function updateMilestones(currentAmount) {
      const milestones = document.querySelectorAll('.milestone');
      milestones.forEach(milestone => {
        const amount = parseInt(milestone.getAttribute('data-amount'));
        if (currentAmount >= amount) {
          milestone.classList.add('achieved');
        } else {
          milestone.classList.remove('achieved');
        }
      });
    }
    
    // Check for milestone achievement and show confetti
    function checkForMilestone() {
      const dailyProgress = calculateDailyProgress();
      const weekProgress = calculateWeekProgress();
      
      // Check for 100% day
      if (dailyProgress === 100) {
        showConfetti('ðŸŽ‰');
      }
      
      // Check for 100% week
      if (weekProgress === 100) {
        showConfetti('ðŸ†');
      }
    }
    
    // Show confetti celebration
    function showConfetti(emoji) {
      const confetti = document.createElement('div');
      confetti.className = 'celebration';
      confetti.textContent = emoji;
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 1000);
    }
    
    // Alias for backwards compatibility
    function updateStats() {
      updateDisplay();
    }

    // Calculate streak
    function calculateStreak() {
      let streak = 0;
      const today = new Date();
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateKey = checkDate.toISOString().split('T')[0];
        const dayData = data.dailyData[dateKey];
        
        if (!dayData) break;
        
        const progress = calculateDayProgress(dateKey);
        if (progress >= 75) {
          streak++;
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    // Update milestone badges
    function updateMilestones(currentAmount) {
      const milestones = document.querySelectorAll('.milestone');
      milestones.forEach(milestone => {
        const amount = parseInt(milestone.dataset.amount);
        if (currentAmount >= amount) {
          milestone.classList.add('achieved');
        } else {
          milestone.classList.remove('achieved');
        }
      });
    }
    
    // Track last milestone to avoid duplicate celebrations
    let lastCelebratedMilestone = 0;
    
    // Check and celebrate milestone achievements
    function checkMilestoneAchievement(currentAmount) {
      const milestones = [1250, 2500, 3750, 5000];
      
      for (const milestone of milestones) {
        if (currentAmount >= milestone && lastCelebratedMilestone < milestone) {
          celebrateMilestone(milestone);
          lastCelebratedMilestone = milestone;
          break;
        }
      }
    }
    
    // Celebrate milestone with confetti
    function celebrateMilestone(amount) {
      // Create confetti effect
      for (let i = 0; i < 50; i++) {
        createConfetti();
      }
      
      // Show milestone toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.background = 'linear-gradient(135deg, #D97757, #E89B7D)';
      toast.innerHTML = `
        <span class="toast-message">ðŸŽ‰ Milestone achieved: $${amount}!</span>
      `;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Create single confetti piece
    function createConfetti() {
      const confetti = document.createElement('div');
      const colors = ['#D97757', '#E89B7D', '#7DBEAA', '#5BA883'];
      const color = colors[Math.floor(Math.random() * colors.length)];
      
      confetti.style.cssText = `
        position: fixed;
        width: 10px;
        height: 10px;
        background: ${color};
        top: -10px;
        left: ${Math.random() * 100}%;
        opacity: 1;
        transform: rotate(${Math.random() * 360}deg);
        z-index: 9999;
        pointer-events: none;
      `;
      
      document.body.appendChild(confetti);
      
      const duration = 2000 + Math.random() * 1000;
      const fallDistance = window.innerHeight + 20;
      const drift = (Math.random() - 0.5) * 200;
      
      confetti.animate([
        { transform: `translateY(0) translateX(0) rotate(0deg)`, opacity: 1 },
        { transform: `translateY(${fallDistance}px) translateX(${drift}px) rotate(${360 * 3}deg)`, opacity: 0 }
      ], {
        duration: duration,
        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      });
      
      setTimeout(() => confetti.remove(), duration);
    }

    // Use grace day
    document.getElementById('graceDayBtn').onclick = function() {
      const todayData = initTodayData();
      const today = getTodayKey();
      
      todayData.graceDay = true;
      data.graceDaysUsed.push(today);
      
      saveData();
    };

    // Toggle view
    let isSimpleView = false;
    document.getElementById('toggleViewBtn').onclick = function() {
      isSimpleView = !isSimpleView;
      document.getElementById('fullView').style.display = isSimpleView ? 'none' : 'block';
      this.textContent = isSimpleView ? 'ðŸ“‹ Full View' : 'âš¡ Simple View';
    };

    // Slider inputs
    document.getElementById('energySlider').oninput = function() {
      const todayData = initTodayData();
      todayData.energy = parseInt(this.value);
      document.getElementById('energyValue').textContent = this.value;
      saveData();
    };

    document.getElementById('anxietySlider').oninput = function() {
      const todayData = initTodayData();
      todayData.anxiety = parseInt(this.value);
      document.getElementById('anxietyValue').textContent = this.value;
      saveData();
    };

    // Number inputs
    ['sleepInput', 'zwiftInput', 'yogaInput'].forEach(id => {
      document.getElementById(id).onchange = function() {
        const todayData = initTodayData();
        const key = id.replace('Input', '');
        todayData[key] = this.value ? parseFloat(this.value) : null;
        saveData();
      };
    });

    // Notes input
    document.getElementById('notesInput').onchange = function() {
      const todayData = initTodayData();
      todayData.notes = this.value;
      saveData();
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Don't trigger if user is typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      // Cmd/Ctrl + 1-4 for quick-log categories
      if ((e.metaKey || e.ctrlKey) && !e.shiftKey) {
        switch(e.key) {
          case '1':
            e.preventDefault();
            quickLog('morning');
            break;
          case '2':
            e.preventDefault();
            quickLog('midday');
            break;
          case '3':
            e.preventDefault();
            quickLog('afternoon');
            break;
          case '4':
            e.preventDefault();
            quickLog('evening');
            break;
          case 'z':
            // Cmd/Ctrl + Z for undo
            e.preventDefault();
            undoLastAction();
            break;
          case 'h':
            // Cmd/Ctrl + H for help
            e.preventDefault();
            document.getElementById('helpModal').style.display = 'block';
            break;
          case ',':
            // Cmd/Ctrl + , for settings
            e.preventDefault();
            document.getElementById('settingsBtn').click();
            break;
        }
      }
      
      // Escape to close modals
      if (e.key === 'Escape') {
        document.getElementById('helpModal').style.display = 'none';
        document.getElementById('settingsModal').style.display = 'none';
        document.getElementById('reportModal').style.display = 'none';
      }
    });

    // Help modal
    document.getElementById('helpBtn').onclick = function() {
      document.getElementById('helpModal').style.display = 'block';
    };
    
    // Health Monitor modal
    document.getElementById('healthBtn').onclick = function() {
      renderHealthData();
      document.getElementById('healthModal').style.display = 'block';
    };

    function closeHelp() {
      document.getElementById('helpModal').style.display = 'none';
    }
    
    function closeHealth() {
      document.getElementById('healthModal').style.display = 'none';
    }
    
    // Switch health tabs
    function switchHealthTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.health-tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.health-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`health-tab-${tabName}`).classList.add('active');
      
      // Render specific tab content
      if (tabName === 'labs') renderLabsList();
      if (tabName === 'symptoms') renderSymptomsList();
      if (tabName === 'meds') renderMedsList();
      if (tabName === 'custom') renderCustomMetricsList();
      if (tabName === 'vitals') loadTodayVitals();
    }

    // Settings modal
    document.getElementById('settingsBtn').onclick = function() {
      // Populate settings
      document.getElementById('emailInput').value = data.settings.email || '';
      document.getElementById('emailReportsEnabled').checked = data.settings.emailReportsEnabled || false;
      document.getElementById('vacationMode').checked = data.settings.vacationMode || false;
      document.getElementById('morningTime').value = data.settings.morningTime || '06:45';
      document.getElementById('middayTime').value = data.settings.middayTime || '10:00';
      document.getElementById('afternoonTime').value = data.settings.afternoonTime || '15:00';
      document.getElementById('eveningTime').value = data.settings.eveningTime || '18:00';
      document.getElementById('fundGoalInput').value = data.settings.fundGoal || 5000;
      
      // Update watch integration status
      updateWatchStatus();
      
      renderEditableChecklists();
      
      document.getElementById('settingsModal').style.display = 'block';
    };

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
      data.settings.email = document.getElementById('emailInput').value;
      data.settings.emailReportsEnabled = document.getElementById('emailReportsEnabled').checked;
      data.settings.vacationMode = document.getElementById('vacationMode').checked;
      data.settings.morningTime = document.getElementById('morningTime').value;
      data.settings.middayTime = document.getElementById('middayTime').value;
      data.settings.afternoonTime = document.getElementById('afternoonTime').value;
      data.settings.eveningTime = document.getElementById('eveningTime').value;
      data.settings.fundGoal = parseInt(document.getElementById('fundGoalInput').value);
      
      saveData();
      closeSettings();
      alert('Settings saved! âœ“');
    }

    function toggleVacation() {
      data.settings.vacationMode = document.getElementById('vacationMode').checked;
      saveData();
    }

    function renderEditableChecklists() {
      const container = document.getElementById('editableChecklists');
      container.innerHTML = '';
      
      const categories = [
        { key: 'morning', title: 'Morning Routine' },
        { key: 'midday', title: 'Midday Break' },
        { key: 'afternoon', title: 'Afternoon Reset' },
        { key: 'evening', title: 'Evening Routine' }
      ];
      
      categories.forEach(cat => {
        const catDiv = document.createElement('div');
        catDiv.className = 'editable-checklist';
        catDiv.innerHTML = `<h4>${cat.title}</h4>`;
        
        data.checklist[cat.key].forEach((item, idx) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'editable-item';
          itemDiv.innerHTML = `
            <input type="time" value="${item.time.replace(' AM', '').replace(' PM', '')}" onchange="updateItemTime('${cat.key}', ${idx}, this.value)">
            <input type="text" value="${item.text}" onchange="updateItemText('${cat.key}', ${idx}, this.value)">
            <button class="btn-small" onclick="removeItem('${cat.key}', ${idx})">âœ•</button>
          `;
          catDiv.appendChild(itemDiv);
        });
        
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-small';
        addBtn.textContent = '+ Add Item';
        addBtn.onclick = () => addItem(cat.key);
        catDiv.appendChild(addBtn);
        
        container.appendChild(catDiv);
      });
    }

    function updateItemTime(category, idx, value) {
      const [hours, minutes] = value.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
      data.checklist[category][idx].time = `${displayHour}:${minutes} ${ampm}`;
      saveData();
    }

    function updateItemText(category, idx, value) {
      data.checklist[category][idx].text = value;
      saveData();
    }

    function removeItem(category, idx) {
      if (confirm('Remove this item?')) {
        data.checklist[category].splice(idx, 1);
        saveData();
        renderEditableChecklists();
        renderChecklist();
      }
    }

    function addItem(category) {
      const text = prompt('Enter new item:');
      if (text) {
        data.checklist[category].push({
          time: '12:00 PM',
          text: text,
          editable: true
        });
        saveData();
        renderEditableChecklists();
        renderChecklist();
      }
    }

    function resetToDefaults() {
      if (confirm('Reset all checklist items to defaults? This cannot be undone.')) {
        data.checklist = JSON.parse(JSON.stringify(defaultChecklist));
        saveData();
        renderEditableChecklists();
        renderChecklist();
        alert('Checklist reset to defaults! âœ“');
      }
    }

    // Weekly report
    document.getElementById('weeklyReportBtn').onclick = function() {
      generateWeeklyReport();
      document.getElementById('reportModal').style.display = 'block';
    };

    function closeReport() {
      document.getElementById('reportModal').style.display = 'none';
    }

    function generateWeeklyReport() {
      const weekKey = getWeekKey();
      const weekStart = new Date(weekKey);
      const today = new Date();
      
      let html = '<div style="font-family: Courier Prime, monospace;">';
      html += `<h3 style="color: var(--terracotta); border-bottom: 2px solid var(--brown); padding-bottom: 10px;">Week of ${weekStart.toLocaleDateString()}</h3>`;
      
      // Daily breakdown
      html += '<div style="margin: 20px 0;"><h4>Daily Progress</h4>';
      for (let i = 0; i < 7; i++) {
        const checkDate = new Date(weekStart);
        checkDate.setDate(weekStart.getDate() + i);
        
        if (checkDate > today) break;
        
        const dateKey = checkDate.toISOString().split('T')[0];
        const dayData = data.dailyData[dateKey];
        const progress = dayData ? calculateDayProgress(dateKey) : 0;
        const dayName = checkDate.toLocaleDateString('en-US', { weekday: 'long' });
        
        const icon = progress >= 75 ? 'âœ…' : progress >= 50 ? 'âš ï¸' : 'âŒ';
        html += `<p>${icon} ${dayName}: ${progress}%</p>`;
      }
      html += '</div>';
      
      // Weekly stats
      const weekProgress = calculateWeekProgress();
      const fundAmount = Math.min(data.settings.fundGoal, (weekProgress / 100) * data.settings.fundGoal);
      
      html += '<div style="background: var(--cream); padding: 15px; border: 2px solid var(--tan); margin: 20px 0;">';
      html += `<h4>Weekly Summary</h4>`;
      html += `<p><strong>Overall Progress:</strong> ${weekProgress}%</p>`;
      html += `<p><strong>GC Trip Fund:</strong> $${Math.round(fundAmount)} / $${data.settings.fundGoal}</p>`;
      html += `<p><strong>Current Streak:</strong> ${calculateStreak()} days</p>`;
      html += '</div>';
      
      // Rewards earned
      if (weekProgress >= 75) {
        html += '<div style="background: var(--rose); padding: 15px; border: 2px solid var(--brown); margin: 20px 0;">';
        html += '<h4>ðŸŽ‰ Rewards Earned This Week!</h4>';
        if (weekProgress >= 75) html += '<p>ðŸ“š Extra reading time</p>';
        if (weekProgress >= 80) html += '<p>ðŸŽ¬ Movie/documentary choice</p>';
        html += '</div>';
      }
      
      // Averages
      const daysWithData = Object.keys(data.dailyData).filter(key => {
        const date = new Date(key);
        return date >= weekStart && date <= today;
      });
      
      if (daysWithData.length > 0) {
        const avgEnergy = daysWithData.reduce((sum, key) => sum + (data.dailyData[key].energy || 0), 0) / daysWithData.length;
        const avgAnxiety = daysWithData.reduce((sum, key) => sum + (data.dailyData[key].anxiety || 0), 0) / daysWithData.length;
        const avgSleep = daysWithData.filter(key => data.dailyData[key].sleep).reduce((sum, key) => sum + (data.dailyData[key].sleep || 0), 0) / daysWithData.filter(key => data.dailyData[key].sleep).length;
        
        html += '<div style="margin: 20px 0;"><h4>Averages</h4>';
        html += `<p><strong>Energy:</strong> ${avgEnergy.toFixed(1)}/10</p>`;
        html += `<p><strong>Anxiety:</strong> ${avgAnxiety.toFixed(1)}/10</p>`;
        if (!isNaN(avgSleep)) html += `<p><strong>Sleep:</strong> ${avgSleep.toFixed(1)} hours</p>`;
        html += '</div>';
      }
      
      html += '</div>';
      
      document.getElementById('reportContent').innerHTML = html;
    }

    function emailReport() {
      if (!data.settings.email) {
        alert('Please set your email address in Settings first!');
        return;
      }
      
      // In a real implementation, this would send to a backend
      alert(`ðŸ“§ Weekly report would be sent to ${data.settings.email}!\n\nNote: Email functionality requires a backend server. For now, you can copy this report manually.`);
    }

    // Initialize
    loadData();
    initializeV2Data(); // V2.0 initialization
    renderChecklist();
    updateDisplay();
    
    // Check if first time user and show onboarding
    function checkFirstTimeUser() {
      const hasCompletedOnboarding = localStorage.getItem('onboardingComplete');
      if (!hasCompletedOnboarding) {
        setTimeout(() => {
          document.getElementById('onboardingModal').style.display = 'block';
        }, 1000);
      }
    }
    
    // Onboarding navigation
    let currentStep = 1;
    let selectedIntegration = null;
    
    function nextOnboardingStep() {
      const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep}"]`);
      currentStepEl.classList.remove('active');
      
      if (currentStep === 2 && selectedIntegration) {
        // Go to integration-specific step
        currentStep = `3-${selectedIntegration}`;
      } else {
        currentStep++;
      }
      
      const nextStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep}"]`);
      if (nextStepEl) {
        nextStepEl.classList.add('active');
      }
    }
    
    function prevOnboardingStep() {
      const currentStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep}"]`);
      currentStepEl.classList.remove('active');
      
      // Go back to step 2 if on integration step
      if (String(currentStep).startsWith('3-')) {
        currentStep = 2;
      } else {
        currentStep--;
      }
      
      const prevStepEl = document.querySelector(`.onboarding-step[data-step="${currentStep}"]`);
      if (prevStepEl) {
        prevStepEl.classList.add('active');
      }
    }
    
    function selectIntegration(method) {
      selectedIntegration = method;
      
      // Update UI
      document.querySelectorAll('.integration-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.getElementById(`option-${method}`).classList.add('selected');
      document.getElementById('continueBtn').disabled = false;
      
      // Save preference
      data.settings.watchIntegration = method;
      saveData();
    }
    
    function skipOnboarding() {
      document.getElementById('onboardingModal').style.display = 'none';
      localStorage.setItem('onboardingComplete', 'skipped');
    }
    
    function completeOnboarding() {
      document.getElementById('onboardingModal').style.display = 'none';
      localStorage.setItem('onboardingComplete', 'true');
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.background = 'linear-gradient(135deg, #5BA883, #7DBEAA)';
      toast.innerHTML = `<span class="toast-message">ðŸŽ‰ Setup complete! Welcome to GC Stride</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function copyWebhookUrl() {
      const url = document.getElementById('webhookUrl').textContent;
      navigator.clipboard.writeText(url).then(() => {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<span class="toast-message">âœ… Webhook URL copied!</span>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      });
    }
    
    function downloadShortcut() {
      // In production, this would download the actual shortcut file
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-message">ðŸ“¥ Shortcut download started! Check your Downloads folder.</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      
      // Simulate download
      alert('In production, this would download a .shortcut file that users can import into the Shortcuts app.');
    }
    
    // Open Apple Watch setup
    function openWatchSetup() {
      // Reset to step 1
      document.querySelectorAll('.onboarding-step').forEach(step => {
        step.classList.remove('active');
      });
      document.querySelector('.onboarding-step[data-step="1"]').classList.add('active');
      currentStep = 1;
      selectedIntegration = null;
      
      // Show modal
      document.getElementById('onboardingModal').style.display = 'block';
    }
    
    // Update watch integration status display
    function updateWatchStatus() {
      const statusContainer = document.getElementById('watchIntegrationStatus');
      if (!statusContainer) return;
      
      const integration = data.settings.watchIntegration;
      const connected = data.settings.watchConnected;
      const lastSync = data.settings.watchLastSync;
      
      let html = '';
      
      if (!integration || integration === 'manual') {
        html = `
          <div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-top: 12px;">
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 0;">
              âš ï¸ Manual entry mode - No automatic sync configured
            </p>
          </div>
        `;
      } else if (integration === 'healthauto') {
        html = `
          <div style="padding: 12px; background: ${connected ? 'rgba(91, 168, 131, 0.1)' : 'rgba(217, 119, 87, 0.1)'}; border-radius: 8px; margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: ${connected ? 'var(--accent-success)' : 'var(--accent-primary)'};"></div>
              <strong style="color: var(--text-primary);">${connected ? 'Connected' : 'Waiting for first sync'}</strong>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 0;">
              Method: Health Auto Export
              ${lastSync ? `<br>Last sync: ${new Date(lastSync).toLocaleString()}` : ''}
            </p>
          </div>
        `;
      } else if (integration === 'shortcuts') {
        html = `
          <div style="padding: 12px; background: rgba(125, 190, 170, 0.1); border-radius: 8px; margin-top: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--accent-teal);"></div>
              <strong style="color: var(--text-primary);">Shortcuts Ready</strong>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.875em; margin: 0;">
              Method: Apple Shortcuts (Manual trigger)
              ${lastSync ? `<br>Last sync: ${new Date(lastSync).toLocaleString()}` : '<br>Run shortcut to sync'}
            </p>
          </div>
        `;
      }
      
      statusContainer.innerHTML = html;
    }
    
    // Simulate receiving webhook/shortcut data
    function receiveWatchData(sleepHours) {
      const todayData = initTodayData();
      todayData.sleep = sleepHours;
      data.settings.watchConnected = true;
      data.settings.watchLastSync = new Date().toISOString();
      saveData();
      updateDisplay();
      updateWatchStatus();
      
      // Show success notification
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.background = 'linear-gradient(135deg, #5BA883, #7DBEAA)';
      toast.innerHTML = `<span class="toast-message">âŒš Sleep data synced: ${sleepHours} hours</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    // Test watch sync (for demo purposes)
    function testWatchSync() {
      const randomSleep = (6 + Math.random() * 3).toFixed(1); // Random between 6-9 hours
      receiveWatchData(parseFloat(randomSleep));
    }
    
    // Check first time user on load
    checkFirstTimeUser();

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Cmd/Ctrl + 1-4 for quick log categories
      if ((e.metaKey || e.ctrlKey) && !e.shiftKey && !e.altKey) {
        const categories = ['morning', 'midday', 'afternoon', 'evening'];
        const num = parseInt(e.key);
        if (num >= 1 && num <= 4) {
          e.preventDefault();
          quickLog(categories[num - 1]);
          return;
        }
        // Cmd/Ctrl + Z for undo
        if (e.key === 'z' || e.key === 'Z') {
          e.preventDefault();
          undoLastAction();
          return;
        }
        // Cmd/Ctrl + H for help
        if (e.key === 'h' || e.key === 'H') {
          e.preventDefault();
          document.getElementById('helpModal').style.display = 'block';
          return;
        }
        // Cmd/Ctrl + , for settings
        if (e.key === ',') {
          e.preventDefault();
          document.getElementById('settingsModal').style.display = 'block';
          return;
        }
      }
      // Escape to close modals or toast
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        const toast = document.querySelector('.toast');
        if (toast) toast.remove();
      }
    });
    
    // Export data as CSV
    function exportData() {
      let csv = 'Date,Daily Progress %,Energy,Anxiety,Sleep Hours,Zwift Min,Yoga Min,Grace Day,Notes\n';
      
      Object.keys(data.dailyData).sort().forEach(dateKey => {
        const dayData = data.dailyData[dateKey];
        const progress = calculateDayProgress(dateKey);
        
        csv += `${dateKey},`;
        csv += `${progress},`;
        csv += `${dayData.energy || ''},`;
        csv += `${dayData.anxiety || ''},`;
        csv += `${dayData.sleep || ''},`;
        csv += `${dayData.zwift || ''},`;
        csv += `${dayData.yoga || ''},`;
        csv += `${dayData.graceDay ? 'Yes' : 'No'},`;
        csv += `"${(dayData.notes || '').replace(/"/g, '""')}"\n`;
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gc-stride-data-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-message">âœ… Data exported successfully!</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // ==================== HEALTH MONITORING FUNCTIONS ====================
    
    // Initialize today's vitals
    function getTodayVitalsKey() {
      return getTodayKey();
    }
    
    // Load today's vitals into form
    function loadTodayVitals() {
      const today = getTodayVitalsKey();
      const vitals = data.healthData.vitals[today] || {};
      
      // Heart Rate
      document.getElementById('restingHR').value = vitals.restingHR || '';
      document.getElementById('avgHR').value = vitals.avgHR || '';
      document.getElementById('maxHR').value = vitals.maxHR || '';
      document.getElementById('walkingHR').value = vitals.walkingHR || '';
      
      // HRV
      document.getElementById('hrvSDNN').value = vitals.hrvSDNN || '';
      
      // Other vitals
      document.getElementById('spo2').value = vitals.spo2 || '';
      document.getElementById('systolic').value = vitals.systolic || '';
      document.getElementById('diastolic').value = vitals.diastolic || '';
      document.getElementById('respRate').value = vitals.respRate || '';
      document.getElementById('vo2max').value = vitals.vo2max || '';
      document.getElementById('steps').value = vitals.steps || '';
      document.getElementById('activeCalories').value = vitals.activeCalories || '';
      document.getElementById('exerciseMins').value = vitals.exerciseMins || '';
      document.getElementById('standHours').value = vitals.standHours || '';
    }
    
    // Save today's vitals
    function saveVitals() {
      const today = getTodayVitalsKey();
      
      data.healthData.vitals[today] = {
        restingHR: parseFloat(document.getElementById('restingHR').value) || null,
        avgHR: parseFloat(document.getElementById('avgHR').value) || null,
        maxHR: parseFloat(document.getElementById('maxHR').value) || null,
        walkingHR: parseFloat(document.getElementById('walkingHR').value) || null,
        hrvSDNN: parseFloat(document.getElementById('hrvSDNN').value) || null,
        spo2: parseFloat(document.getElementById('spo2').value) || null,
        systolic: parseFloat(document.getElementById('systolic').value) || null,
        diastolic: parseFloat(document.getElementById('diastolic').value) || null,
        respRate: parseFloat(document.getElementById('respRate').value) || null,
        vo2max: parseFloat(document.getElementById('vo2max').value) || null,
        steps: parseInt(document.getElementById('steps').value) || null,
        activeCalories: parseInt(document.getElementById('activeCalories').value) || null,
        exerciseMins: parseInt(document.getElementById('exerciseMins').value) || null,
        standHours: parseInt(document.getElementById('standHours').value) || null,
        timestamp: new Date().toISOString()
      };
      
      saveData();
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.background = 'linear-gradient(135deg, #5BA883, #7DBEAA)';
      toast.innerHTML = `<span class="toast-message">âœ… Vitals saved successfully!</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // Render health data
    function renderHealthData() {
      loadTodayVitals();
      renderLabsList();
      renderSymptomsList();
      renderMedsList();
      renderCustomMetricsList();
    }
    
    // Labs Functions
    function renderLabsList() {
      const container = document.getElementById('labsList');
      if (!data.healthData.labs || data.healthData.labs.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            <p>No lab results yet. Click "+ Add Lab Result" to start tracking.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = data.healthData.labs
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .map((lab, idx) => {
          const valueClass = lab.status === 'normal' ? '' : (lab.status === 'warning' ? 'warning' : 'danger');
          return `
            <div class="lab-item">
              <div class="lab-date">${new Date(lab.date).toLocaleDateString()}</div>
              <div class="lab-name">${lab.name}</div>
              <div class="lab-value ${valueClass}">${lab.value} ${lab.unit}</div>
              <div class="lab-range">${lab.range || 'N/A'}</div>
              <div style="font-size: 0.875em; color: var(--text-secondary);">${lab.notes || ''}</div>
              <button class="btn-small" onclick="deleteLab(${idx})">Delete</button>
            </div>
          `;
        }).join('');
    }
    
    function showAddLabModal() {
      const name = prompt('Lab/Biomarker Name (e.g., "Vitamin D", "Cholesterol LDL"):');
      if (!name) return;
      
      const value = prompt('Value:');
      if (!value) return;
      
      const unit = prompt('Unit (e.g., "ng/mL", "mg/dL"):');
      if (!unit) return;
      
      const range = prompt('Reference Range (optional, e.g., "30-100"):');
      const notes = prompt('Notes (optional):');
      
      data.healthData.labs.push({
        date: new Date().toISOString(),
        name: name,
        value: parseFloat(value),
        unit: unit,
        range: range || '',
        notes: notes || '',
        status: 'normal' // User should manually set this based on range
      });
      
      saveData();
      renderLabsList();
    }
    
    function deleteLab(idx) {
      if (confirm('Delete this lab result?')) {
        data.healthData.labs.splice(idx, 1);
        saveData();
        renderLabsList();
      }
    }
    
    // Symptoms Functions
    function renderSymptomsList() {
      const today = getTodayKey();
      const container = document.getElementById('symptomsList');
      const symptoms = data.healthData.symptoms[today] || [];
      
      if (symptoms.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            <p>No symptoms logged today. Use the form above to track symptoms.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = symptoms.map((symptom, idx) => {
        const severityClass = symptom.severity <= 3 ? 'low' : (symptom.severity <= 6 ? 'medium' : 'high');
        return `
          <div class="symptom-item">
            <div>
              <strong style="color: var(--text-primary); font-size: 1.0625em;">${symptom.name}</strong>
              <div style="color: var(--text-secondary); font-size: 0.875em; margin-top: 4px;">
                ${symptom.time} | Severity: ${symptom.severity}/10
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span class="symptom-severity ${severityClass}">${symptom.severity}/10</span>
              <button class="btn-small" onclick="deleteSymptom(${idx})">Remove</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function addSymptom() {
      const name = document.getElementById('symptomName').value;
      const severity = parseInt(document.getElementById('symptomSeverity').value);
      const time = document.getElementById('symptomTime').value;
      
      if (!name || !severity || !time) {
        alert('Please fill in all fields');
        return;
      }
      
      const today = getTodayKey();
      if (!data.healthData.symptoms[today]) {
        data.healthData.symptoms[today] = [];
      }
      
      data.healthData.symptoms[today].push({
        name: name,
        severity: severity,
        time: time,
        timestamp: new Date().toISOString()
      });
      
      // Clear form
      document.getElementById('symptomName').value = '';
      document.getElementById('symptomSeverity').value = '';
      document.getElementById('symptomTime').value = '';
      
      saveData();
      renderSymptomsList();
    }
    
    function deleteSymptom(idx) {
      const today = getTodayKey();
      data.healthData.symptoms[today].splice(idx, 1);
      saveData();
      renderSymptomsList();
    }
    
    // Medications Functions
    function renderMedsList() {
      const container = document.getElementById('medsList');
      if (!data.healthData.medications || data.healthData.medications.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            <p>No medications tracked. Click "+ Add Medication" to start.</p>
          </div>
        `;
        return;
      }
      
      const today = new Date();
      container.innerHTML = data.healthData.medications.map((med, idx) => {
        const isActive = !med.endDate || new Date(med.endDate) > today;
        return `
          <div class="med-item ${isActive ? 'active' : ''}">
            <div class="med-header">
              <div class="med-name">${med.name}</div>
              <span class="med-badge ${isActive ? 'active' : 'ended'}">${isActive ? 'Active' : 'Ended'}</span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; color: var(--text-secondary); font-size: 0.875em;">
              <div><strong>Dosage:</strong> ${med.dosage}</div>
              <div><strong>Frequency:</strong> ${med.frequency}</div>
              <div><strong>Started:</strong> ${new Date(med.startDate).toLocaleDateString()}</div>
              ${med.endDate ? `<div><strong>Ended:</strong> ${new Date(med.endDate).toLocaleDateString()}</div>` : ''}
            </div>
            ${med.notes ? `<div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.875em; color: var(--text-secondary);">${med.notes}</div>` : ''}
            <button class="btn-small" onclick="deleteMed(${idx})" style="margin-top: 12px;">Delete</button>
          </div>
        `;
      }).join('');
    }
    
    function showAddMedModal() {
      const name = prompt('Medication/Supplement Name:');
      if (!name) return;
      
      const dosage = prompt('Dosage (e.g., "5mg", "1 capsule"):');
      if (!dosage) return;
      
      const frequency = prompt('Frequency (e.g., "Once daily", "Twice daily"):');
      if (!frequency) return;
      
      const notes = prompt('Notes (optional):');
      
      data.healthData.medications.push({
        name: name,
        dosage: dosage,
        frequency: frequency,
        startDate: new Date().toISOString(),
        endDate: null,
        notes: notes || ''
      });
      
      saveData();
      renderMedsList();
    }
    
    function deleteMed(idx) {
      if (confirm('Delete this medication?')) {
        data.healthData.medications.splice(idx, 1);
        saveData();
        renderMedsList();
      }
    }
    
    // Custom Metrics Functions
    function renderCustomMetricsList() {
      const today = getTodayKey();
      const container = document.getElementById('customMetricsList');
      const metrics = data.healthData.customMetrics[today] || [];
      
      if (metrics.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
            <p>No custom metrics logged today. Use the form above to track any metric.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
          ${metrics.map((metric, idx) => `
            <div class="stat-card">
              <h3>${metric.name}</h3>
              <div class="stat-value">${metric.value} ${metric.unit}</div>
              <button class="btn-small" onclick="deleteCustomMetric(${idx})" style="margin-top: 12px; width: 100%;">Delete</button>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function addCustomMetric() {
      const name = document.getElementById('customMetricName').value;
      const value = parseFloat(document.getElementById('customMetricValue').value);
      const unit = document.getElementById('customMetricUnit').value;
      
      if (!name || isNaN(value) || !unit) {
        alert('Please fill in all fields');
        return;
      }
      
      const today = getTodayKey();
      if (!data.healthData.customMetrics[today]) {
        data.healthData.customMetrics[today] = [];
      }
      
      data.healthData.customMetrics[today].push({
        name: name,
        value: value,
        unit: unit,
        timestamp: new Date().toISOString()
      });
      
      // Clear form
      document.getElementById('customMetricName').value = '';
      document.getElementById('customMetricValue').value = '';
      document.getElementById('customMetricUnit').value = '';
      
      saveData();
      renderCustomMetricsList();
    }
    
    function deleteCustomMetric(idx) {
      const today = getTodayKey();
      data.healthData.customMetrics[today].splice(idx, 1);
      saveData();
      renderCustomMetricsList();
    }
    
    // ==================== HEALTH DATA EXPORT FUNCTIONS ====================
    
    function exportCompleteHealthData() {
      let csv = 'Date,RestingHR,AvgHR,MaxHR,WalkingHR,HRV,SpO2,Systolic,Diastolic,RespRate,VO2Max,Steps,ActiveCal,ExerciseMins,StandHours,Sleep,Energy,Anxiety,Notes\n';
      
      // Merge daily data and vitals
      const allDates = new Set([
        ...Object.keys(data.dailyData),
        ...Object.keys(data.healthData.vitals)
      ]);
      
      Array.from(allDates).sort().forEach(date => {
        const daily = data.dailyData[date] || {};
        const vitals = data.healthData.vitals[date] || {};
        
        csv += `${date},`;
        csv += `${vitals.restingHR || ''},`;
        csv += `${vitals.avgHR || ''},`;
        csv += `${vitals.maxHR || ''},`;
        csv += `${vitals.walkingHR || ''},`;
        csv += `${vitals.hrvSDNN || ''},`;
        csv += `${vitals.spo2 || ''},`;
        csv += `${vitals.systolic || ''},`;
        csv += `${vitals.diastolic || ''},`;
        csv += `${vitals.respRate || ''},`;
        csv += `${vitals.vo2max || ''},`;
        csv += `${vitals.steps || ''},`;
        csv += `${vitals.activeCalories || ''},`;
        csv += `${vitals.exerciseMins || ''},`;
        csv += `${vitals.standHours || ''},`;
        csv += `${daily.sleep || ''},`;
        csv += `${daily.energy || ''},`;
        csv += `${daily.anxiety || ''},`;
        csv += `"${(daily.notes || '').replace(/"/g, '""')}"\n`;
      });
      
      downloadCSV(csv, 'gc-stride-complete-health-data.csv');
    }
    
    function exportLabsData() {
      let csv = 'Date,Biomarker,Value,Unit,ReferenceRange,Status,Notes\n';
      
      data.healthData.labs.forEach(lab => {
        csv += `${new Date(lab.date).toISOString().split('T')[0]},`;
        csv += `${lab.name},`;
        csv += `${lab.value},`;
        csv += `${lab.unit},`;
        csv += `"${lab.range}",`;
        csv += `${lab.status},`;
        csv += `"${(lab.notes || '').replace(/"/g, '""')}"\n`;
      });
      
      downloadCSV(csv, 'gc-stride-labs-biomarkers.csv');
    }
    
    function exportVitalsData() {
      let csv = 'Date,RestingHR,AvgHR,MaxHR,WalkingHR,HRV_SDNN,SpO2,Systolic,Diastolic,RespRate,VO2Max,Steps,ActiveCalories,ExerciseMins,StandHours\n';
      
      Object.keys(data.healthData.vitals).sort().forEach(date => {
        const v = data.healthData.vitals[date];
        csv += `${date},${v.restingHR || ''},${v.avgHR || ''},${v.maxHR || ''},${v.walkingHR || ''},${v.hrvSDNN || ''},${v.spo2 || ''},${v.systolic || ''},${v.diastolic || ''},${v.respRate || ''},${v.vo2max || ''},${v.steps || ''},${v.activeCalories || ''},${v.exerciseMins || ''},${v.standHours || ''}\n`;
      });
      
      downloadCSV(csv, 'gc-stride-apple-watch-vitals.csv');
    }
    
    function exportHealthJSON() {
      const json = JSON.stringify(data.healthData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gc-stride-health-data-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-message">âœ… JSON exported successfully!</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-message">âœ… Data exported successfully!</span>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // ==================== V2.0 FEATURES JAVASCRIPT ====================
    
    // V2 State Management
    let currentCalendarMonth = new Date().getMonth();
    let currentCalendarYear = new Date().getFullYear();
    let currentEditingDate = null;

    // Initialize v2 data structure
    function initializeV2Data() {
      if (!data.dailyData) data.dailyData = {};
      if (!data.taskTemplates) {
        data.taskTemplates = {
          default: JSON.parse(JSON.stringify(defaultChecklist))
        };
      }
      if (!data.profile) {
        data.profile = {
          name: "Laura",
          email: "lklevin1@gmail.com",
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };
      }
    }

    // ==================== CALENDAR VIEW ====================

    // Open calendar view
    function openCalendar() {
      document.getElementById('calendarView').classList.add('active');
      const mainDashboard = document.querySelector('.container > div:not(#calendarView):not(.modal):not(.onboarding-modal)');
      if (mainDashboard) mainDashboard.style.display = 'none';
      renderCalendar();
    }

    // Close calendar view
    function closeCalendar() {
      document.getElementById('calendarView').classList.remove('active');
      const mainDashboard = document.querySelector('.container > div:not(#calendarView):not(.modal):not(.onboarding-modal)');
      if (mainDashboard) mainDashboard.style.display = 'block';
    }

    // Render calendar
    function renderCalendar() {
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDayOfWeek = firstDay.getDay();
      
      const months = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
      
      document.getElementById('calendarMonthYear').textContent = 
        `${months[currentCalendarMonth]} ${currentCalendarYear}`;
      
      let html = '<div class="calendar-grid">';
      
      // Day headers
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });
      
      // Empty cells before month starts
      for (let i = 0; i < startingDayOfWeek; i++) {
        html += '<div class="calendar-day empty"></div>';
      }
      
      // Days of month
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayData = data.dailyData[dateStr];
        const completion = calculateDayCompletion(dateStr);
        
        let className = 'calendar-day';
        if (dateStr === todayStr) className += ' today';
        if (new Date(dateStr) > today) className += ' future';
        
        if (completion >= 75) className += ' completion-high';
        else if (completion >= 50) className += ' completion-medium';
        else if (completion >= 25) className += ' completion-low';
        else className += ' completion-none';
        
        const hasReflection = dayData && dayData.reflection;
        const isGraceDay = dayData && dayData.graceDay;
        
        html += `
          <div class="${className}" onclick="openDayDetail('${dateStr}')">
            <div class="day-number">${day}</div>
            <div class="day-completion">${Math.round(completion)}%</div>
            <div class="day-indicators">
              ${hasReflection ? '<div class="day-indicator-dot reflection" title="Has reflection"></div>' : ''}
              ${isGraceDay ? '<div class="day-indicator-dot grace" title="Grace day"></div>' : ''}
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      document.getElementById('calendarContainer').innerHTML = html;
    }

    // Calculate completion for a specific day
    function calculateDayCompletion(dateStr) {
      const dayData = data.dailyData[dateStr];
      if (!dayData) return 0;
      if (dayData.graceDay) return 100;
      
      const tasks = getTasksForDate(dateStr);
      let totalTasks = 0;
      let completedTasks = 0;
      
      Object.keys(tasks).forEach(category => {
        tasks[category].forEach((task, idx) => {
          totalTasks++;
          const key = `${category}-${idx}`;
          if (dayData.completed && dayData.completed[key]) {
            completedTasks++;
          }
        });
      });
      
      return totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
    }

    // Get tasks for a specific date (custom or default)
    function getTasksForDate(dateStr) {
      const dayData = data.dailyData[dateStr];
      if (dayData && dayData.customTasks) {
        return dayData.customTasks;
      }
      return data.taskTemplates && data.taskTemplates.default ? data.taskTemplates.default : defaultChecklist;
    }

    // Calendar navigation
    function previousMonth() {
      currentCalendarMonth--;
      if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      renderCalendar();
    }

    function nextMonth() {
      currentCalendarMonth++;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      }
      renderCalendar();
    }

    function goToToday() {
      const today = new Date();
      currentCalendarMonth = today.getMonth();
      currentCalendarYear = today.getFullYear();
      renderCalendar();
    }

    // ==================== DAY DETAIL MODAL ====================

    function openDayDetail(dateStr) {
      currentEditingDate = dateStr;
      const dayData = data.dailyData[dateStr] || {};
      const completion = calculateDayCompletion(dateStr);
      
      const date = new Date(dateStr);
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById('dayDetailDate').textContent = formattedDate;
      document.getElementById('dayDetailCompletion').textContent = `${Math.round(completion)}% Complete`;
      
      // Stats
      let statsHtml = '';
      if (dayData.energy) {
        statsHtml += `
          <div class="stat-mini">
            <div class="stat-mini-label">Energy</div>
            <div class="stat-mini-value">${dayData.energy}/10</div>
          </div>
        `;
      }
      if (dayData.anxiety) {
        statsHtml += `
          <div class="stat-mini">
            <div class="stat-mini-label">Anxiety</div>
            <div class="stat-mini-value">${dayData.anxiety}/10</div>
          </div>
        `;
      }
      if (dayData.sleep) {
        statsHtml += `
          <div class="stat-mini">
            <div class="stat-mini-label">Sleep</div>
            <div class="stat-mini-value">${dayData.sleep}h</div>
          </div>
        `;
      }
      if (dayData.zwift) {
        statsHtml += `
          <div class="stat-mini">
            <div class="stat-mini-label">Zwift</div>
            <div class="stat-mini-value">${dayData.zwift}min</div>
          </div>
        `;
      }
      document.getElementById('dayDetailStats').innerHTML = statsHtml;
      
      // Tasks
      const tasks = getTasksForDate(dateStr);
      let tasksHtml = '';
      Object.keys(tasks).forEach(category => {
        tasksHtml += `<div class="day-task-category">`;
        tasksHtml += `<h4>${getCategoryTitle(category)}</h4>`;
        tasks[category].forEach((task, idx) => {
          const key = `${category}-${idx}`;
          const isCompleted = dayData.completed && dayData.completed[key];
          tasksHtml += `
            <div class="day-task-item ${isCompleted ? 'completed' : ''}">
              <span class="task-check">${isCompleted ? 'âœ…' : 'â¬œ'}</span>
              <span>${task.time} - ${task.text}</span>
            </div>
          `;
        });
        tasksHtml += `</div>`;
      });
      document.getElementById('dayTasksList').innerHTML = tasksHtml;
      
      // Reflection
      if (dayData.reflection) {
        const r = dayData.reflection;
        document.getElementById('dayReflectionView').innerHTML = `
          <div class="reflection-view">
            <h3 style="margin-top: 24px;">ðŸ“ Daily Reflection</h3>
            <div class="reflection-content">
              <div class="reflection-section">
                <h3>Overall Feeling</h3>
                <div class="feeling-indicator" style="width: ${r.overallFeeling * 10}%">
                  ${r.overallFeeling}/10
                </div>
              </div>
              ${r.wentWell ? `
                <div class="reflection-section">
                  <h3>What Went Well</h3>
                  <p>${r.wentWell}</p>
                </div>
              ` : ''}
              ${r.improve ? `
                <div class="reflection-section">
                  <h3>Areas to Improve</h3>
                  <p>${r.improve}</p>
                </div>
              ` : ''}
              ${r.insight ? `
                <div class="reflection-section">
                  <h3>Key Insight</h3>
                  <p>${r.insight}</p>
                </div>
              ` : ''}
              ${r.intention ? `
                <div class="reflection-section">
                  <h3>Tomorrow's Intention</h3>
                  <p>${r.intention}</p>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      } else {
        document.getElementById('dayReflectionView').innerHTML = '';
      }
      
      document.getElementById('dayDetailModal').style.display = 'block';
    }

    function closeDayDetail() {
      document.getElementById('dayDetailModal').style.display = 'none';
    }

    function getCategoryTitle(category) {
      const titles = {
        morning: 'ðŸŒ… Morning Routine',
        midday: 'â˜€ï¸ Midday Break',
        afternoon: 'ðŸŒ¤ï¸ Afternoon Reset',
        evening: 'ðŸŒ™ Evening Routine'
      };
      return titles[category] || category;
    }

    // ==================== REFLECTION SYSTEM ====================

    function openReflectionForDay() {
      if (!currentEditingDate) {
        currentEditingDate = getTodayDateString();
      }
      closeDayDetail();
      openReflectionModal(currentEditingDate);
    }

    function openReflectionModal(dateStr) {
      currentEditingDate = dateStr;
      const date = new Date(dateStr);
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById('reflectionDate').textContent = `Daily Reflection - ${formattedDate}`;
      
      // Load existing reflection if any
      const dayData = data.dailyData[dateStr];
      if (dayData && dayData.reflection) {
        const r = dayData.reflection;
        document.getElementById('overallFeeling').value = r.overallFeeling || 5;
        document.getElementById('feelingValue').textContent = r.overallFeeling || 5;
        document.getElementById('wentWell').value = r.wentWell || '';
        document.getElementById('toImprove').value = r.improve || '';
        document.getElementById('keyInsight').value = r.insight || '';
        document.getElementById('tomorrowIntention').value = r.intention || '';
      } else {
        // Reset form
        document.getElementById('overallFeeling').value = 5;
        document.getElementById('feelingValue').textContent = 5;
        document.getElementById('wentWell').value = '';
        document.getElementById('toImprove').value = '';
        document.getElementById('keyInsight').value = '';
        document.getElementById('tomorrowIntention').value = '';
      }
      
      document.getElementById('reflectionModal').style.display = 'block';
    }

    function updateFeelingValue() {
      const value = document.getElementById('overallFeeling').value;
      document.getElementById('feelingValue').textContent = value;
    }

    function saveReflection() {
      if (!currentEditingDate) return;
      
      const reflection = {
        overallFeeling: parseInt(document.getElementById('overallFeeling').value),
        wentWell: document.getElementById('wentWell').value,
        improve: document.getElementById('toImprove').value,
        insight: document.getElementById('keyInsight').value,
        intention: document.getElementById('tomorrowIntention').value,
        createdAt: new Date().toISOString()
      };
      
      if (!data.dailyData[currentEditingDate]) {
        data.dailyData[currentEditingDate] = {};
      }
      data.dailyData[currentEditingDate].reflection = reflection;
      
      saveData();
      closeReflectionModal();
      showToast('Reflection saved! ðŸ“');
      
      // Refresh calendar if open
      if (document.getElementById('calendarView').classList.contains('active')) {
        renderCalendar();
      }
    }

    function skipReflection() {
      closeReflectionModal();
    }

    function closeReflectionModal() {
      document.getElementById('reflectionModal').style.display = 'none';
    }

    // ==================== TASK EDITOR ====================

    function openTaskEditorForDay() {
      if (!currentEditingDate) {
        currentEditingDate = getTodayDateString();
      }
      closeDayDetail();
      openTaskEditor(currentEditingDate);
    }

    function openTaskEditor(dateStr) {
      currentEditingDate = dateStr;
      const date = new Date(dateStr);
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById('taskEditorDate').textContent = `Edit Tasks for ${formattedDate}`;
      
      const tasks = getTasksForDate(dateStr);
      let html = '';
      
      Object.keys(tasks).forEach(category => {
        html += `
          <div class="category-editor">
            <h3>${getCategoryTitle(category)}</h3>
            <div class="task-list-editor" data-category="${category}">
        `;
        
        tasks[category].forEach((task, idx) => {
          html += `
            <div class="editable-task-item">
              <span class="drag-handle">â˜°</span>
              <input type="time" value="${task.time}" data-category="${category}" data-index="${idx}" class="task-time-input">
              <input type="text" value="${task.text}" data-category="${category}" data-index="${idx}" class="task-text-input">
              <button class="task-delete-btn" onclick="deleteTaskInEditor('${category}', ${idx})">Ã—</button>
            </div>
          `;
        });
        
        html += `
            </div>
            <button class="add-task-btn" onclick="addTaskInEditor('${category}')">+ Add Task</button>
          </div>
        `;
      });
      
      document.getElementById('taskEditorContent').innerHTML = html;
      document.getElementById('taskEditorModal').style.display = 'block';
    }

    function saveCustomTasks() {
      if (!currentEditingDate) return;
      
      const customTasks = {};
      const categories = ['morning', 'midday', 'afternoon', 'evening'];
      
      categories.forEach(category => {
        customTasks[category] = [];
        const timeInputs = document.querySelectorAll(`input.task-time-input[data-category="${category}"]`);
        const textInputs = document.querySelectorAll(`input.task-text-input[data-category="${category}"]`);
        
        for (let i = 0; i < timeInputs.length; i++) {
          customTasks[category].push({
            time: timeInputs[i].value,
            text: textInputs[i].value
          });
        }
      });
      
      if (!data.dailyData[currentEditingDate]) {
        data.dailyData[currentEditingDate] = {};
      }
      data.dailyData[currentEditingDate].customTasks = customTasks;
      
      saveData();
      closeTaskEditor();
      showToast('Tasks updated! âœï¸');
      
      // Refresh calendar if open
      if (document.getElementById('calendarView').classList.contains('active')) {
        renderCalendar();
      }
      
      // Refresh checklist if editing today
      if (currentEditingDate === getTodayDateString()) {
        data.checklist = customTasks;
        renderChecklist();
      }
    }

    function deleteTaskInEditor(category, index) {
      const container = document.querySelector(`.task-list-editor[data-category="${category}"]`);
      const items = container.querySelectorAll('.editable-task-item');
      if (items[index]) {
        items[index].remove();
      }
    }

    function addTaskInEditor(category) {
      const time = prompt('Task time (HH:MM):', '12:00');
      const text = prompt('Task description:', '');
      
      if (time && text) {
        const container = document.querySelector(`.task-list-editor[data-category="${category}"]`);
        const newItem = document.createElement('div');
        newItem.className = 'editable-task-item';
        const nextIndex = container.querySelectorAll('.editable-task-item').length;
        newItem.innerHTML = `
          <span class="drag-handle">â˜°</span>
          <input type="time" value="${time}" data-category="${category}" data-index="${nextIndex}" class="task-time-input">
          <input type="text" value="${text}" data-category="${category}" data-index="${nextIndex}" class="task-text-input">
          <button class="task-delete-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        container.appendChild(newItem);
      }
    }

    function resetToDefaultTasks() {
      if (confirm('Reset tasks to default template? This will remove all customizations for this day.')) {
        if (data.dailyData[currentEditingDate]) {
          delete data.dailyData[currentEditingDate].customTasks;
          saveData();
          closeTaskEditor();
          showToast('Tasks reset to default');
          if (currentEditingDate === getTodayDateString()) {
            data.checklist = defaultChecklist;
            renderChecklist();
          }
        }
      }
    }

    function saveAsTemplate() {
      const name = prompt('Template name:', 'My Template');
      if (name) {
        const customTasks = {};
        const categories = ['morning', 'midday', 'afternoon', 'evening'];
        
        categories.forEach(category => {
          customTasks[category] = [];
          const timeInputs = document.querySelectorAll(`input.task-time-input[data-category="${category}"]`);
          const textInputs = document.querySelectorAll(`input.task-text-input[data-category="${category}"]`);
          
          for (let i = 0; i < timeInputs.length; i++) {
            customTasks[category].push({
              time: timeInputs[i].value,
              text: textInputs[i].value
            });
          }
        });
        
        if (!data.taskTemplates) data.taskTemplates = {};
        data.taskTemplates[name] = customTasks;
        saveData();
        showToast(`Template "${name}" saved!`);
      }
    }

    function applyToDateRange() {
      const startDate = prompt('Start date (YYYY-MM-DD):', currentEditingDate);
      const endDate = prompt('End date (YYYY-MM-DD):', currentEditingDate);
      
      if (startDate && endDate) {
        const customTasks = {};
        const categories = ['morning', 'midday', 'afternoon', 'evening'];
        
        categories.forEach(category => {
          customTasks[category] = [];
          const timeInputs = document.querySelectorAll(`input.task-time-input[data-category="${category}"]`);
          const textInputs = document.querySelectorAll(`input.task-text-input[data-category="${category}"]`);
          
          for (let i = 0; i < timeInputs.length; i++) {
            customTasks[category].push({
              time: timeInputs[i].value,
              text: textInputs[i].value
            });
          }
        });
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        let count = 0;
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          if (!data.dailyData[dateStr]) data.dailyData[dateStr] = {};
          data.dailyData[dateStr].customTasks = JSON.parse(JSON.stringify(customTasks));
          count++;
        }
        
        saveData();
        showToast(`Tasks applied to ${count} days`);
      }
    }

    function closeTaskEditor() {
      document.getElementById('taskEditorModal').style.display = 'none';
    }

    // ==================== WEEKLY SUMMARY ====================

    function generateWeeklySummary() {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(endDate.getDate() - 6);
      
      const weekData = analyzeWeekData(startDate, endDate);
      const summaryHtml = buildSummaryHTML(weekData);
      
      document.getElementById('weeklySummaryContent').innerHTML = summaryHtml;
      document.getElementById('weeklySummaryModal').style.display = 'block';
    }

    function analyzeWeekData(startDate, endDate) {
      const dateArray = [];
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        dateArray.push(new Date(d));
      }
      
      let totalCompletion = 0;
      let totalSleep = 0;
      let totalEnergy = 0;
      let totalAnxiety = 0;
      let sleepCount = 0;
      let energyCount = 0;
      let anxietyCount = 0;
      let completionCount = 0;
      
      const reflectionThemes = [];
      const challenges = [];
      
      dateArray.forEach(date => {
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const dayData = data.dailyData[dateStr];
        
        if (dayData) {
          const completion = calculateDayCompletion(dateStr);
          totalCompletion += completion;
          completionCount++;
          
          if (dayData.sleep) {
            totalSleep += parseFloat(dayData.sleep);
            sleepCount++;
          }
          if (dayData.energy) {
            totalEnergy += parseFloat(dayData.energy);
            energyCount++;
          }
          if (dayData.anxiety) {
            totalAnxiety += parseFloat(dayData.anxiety);
            anxietyCount++;
          }
          
          if (dayData.reflection) {
            if (dayData.reflection.insight) reflectionThemes.push(dayData.reflection.insight);
            if (dayData.reflection.improve) challenges.push(dayData.reflection.improve);
          }
        }
      });
      
      return {
        startDate: startDate.toLocaleDateString(),
        endDate: endDate.toLocaleDateString(),
        averageCompletion: completionCount > 0 ? totalCompletion / completionCount : 0,
        averageSleep: sleepCount > 0 ? totalSleep / sleepCount : 0,
        averageEnergy: energyCount > 0 ? totalEnergy / energyCount : 0,
        averageAnxiety: anxietyCount > 0 ? totalAnxiety / anxietyCount : 0,
        streak: data.streak || 0,
        reflectionThemes,
        challenges
      };
    }

    function buildSummaryHTML(weekData) {
      return `
        <div class="summary-section">
          <h3>ðŸ“Š Week Overview</h3>
          <p style="color: var(--text-secondary); margin-bottom: 16px;">
            ${weekData.startDate} - ${weekData.endDate}
          </p>
          
          <div class="summary-stats-grid">
            <div class="summary-stat">
              <div class="summary-stat-label">Average Completion</div>
              <div class="summary-stat-value">${Math.round(weekData.averageCompletion)}%</div>
            </div>
            
            <div class="summary-stat">
              <div class="summary-stat-label">Average Sleep</div>
              <div class="summary-stat-value">${weekData.averageSleep.toFixed(1)}h</div>
            </div>
            
            <div class="summary-stat">
              <div class="summary-stat-label">Average Energy</div>
              <div class="summary-stat-value">${weekData.averageEnergy.toFixed(1)}/10</div>
            </div>
            
            <div class="summary-stat">
              <div class="summary-stat-label">Average Anxiety</div>
              <div class="summary-stat-value">${weekData.averageAnxiety.toFixed(1)}/10</div>
            </div>
            
            <div class="summary-stat">
              <div class="summary-stat-label">Current Streak</div>
              <div class="summary-stat-value">${weekData.streak} days</div>
            </div>
          </div>
        </div>
        
        <div class="summary-section">
          <h3>ðŸ’¡ Key Observations</h3>
          ${generateObservations(weekData)}
        </div>
        
        <div class="summary-section">
          <h3>ðŸŽ¯ Recommendations</h3>
          ${generateRecommendations(weekData)}
        </div>
        
        <div class="summary-section">
          <h3>ðŸ“š Recommended Resources</h3>
          ${generateResources(weekData)}
        </div>
      `;
    }

    function generateObservations(weekData) {
      let html = '';
      
      if (weekData.averageCompletion >= 75) {
        html += `
          <div class="recommendation-item">
            <h4>ðŸŽ‰ Excellent Consistency!</h4>
            <p>You maintained ${Math.round(weekData.averageCompletion)}% completion this week. Keep up the great work!</p>
          </div>
        `;
      } else if (weekData.averageCompletion >= 50) {
        html += `
          <div class="recommendation-item">
            <h4>ðŸ’ª Good Progress</h4>
            <p>At ${Math.round(weekData.averageCompletion)}% completion, you're making steady progress. A few more consistent days and you'll hit 75%!</p>
          </div>
        `;
      }
      
      if (weekData.averageSleep < 7) {
        html += `
          <div class="recommendation-item">
            <h4>ðŸ˜´ Sleep Needs Attention</h4>
            <p>Your average sleep (${weekData.averageSleep.toFixed(1)}h) is below the recommended 7-9 hours. Sleep impacts everything!</p>
          </div>
        `;
      }
      
      if (weekData.averageEnergy >= 7) {
        html += `
          <div class="recommendation-item">
            <h4>âš¡ High Energy Levels</h4>
            <p>Your energy averaged ${weekData.averageEnergy.toFixed(1)}/10 this week - great! Note what you're doing right.</p>
          </div>
        `;
      }
      
      return html || '<p style="color: var(--text-secondary);">Keep tracking to see patterns emerge!</p>';
    }

    function generateRecommendations(weekData) {
      let html = '';
      
      if (weekData.averageSleep < 7) {
        html += `
          <div class="recommendation-item">
            <h4>Optimize Sleep Schedule</h4>
            <p>Try moving your evening routine 30 minutes earlier. Aim for lights out by 10 PM for better recovery.</p>
          </div>
        `;
      }
      
      if (weekData.averageAnxiety > 5) {
        html += `
          <div class="recommendation-item">
            <h4>Stress Management</h4>
            <p>Your anxiety averaged ${weekData.averageAnxiety.toFixed(1)}/10. Consider adding 5-10 minutes of breathwork to your morning routine.</p>
          </div>
        `;
      }
      
      if (weekData.averageCompletion < 75) {
        html += `
          <div class="recommendation-item">
            <h4>Build Consistency</h4>
            <p>Focus on completing just one more routine category daily to reach your 75% goal.</p>
          </div>
        `;
      }
      
      return html || '<p style="color: var(--text-secondary);">You\'re doing great! Keep it up!</p>';
    }

    function generateResources(weekData) {
      const resources = [];
      
      if (weekData.averageSleep < 7) {
        resources.push({
          type: 'podcast',
          title: 'Sleep Toolkit - Huberman Lab',
          relevance: 'Science-based sleep optimization',
          url: 'https://hubermanlab.com/toolkit-for-sleep/'
        });
      }
      
      if (weekData.averageAnxiety > 5) {
        resources.push({
          type: 'article',
          title: 'Box Breathing Technique',
          relevance: 'Quick stress reduction method',
          url: 'https://www.healthline.com/health/box-breathing'
        });
      }
      
      if (weekData.averageCompletion < 60) {
        resources.push({
          type: 'book',
          title: 'Atomic Habits by James Clear',
          relevance: 'Building consistency and habits',
          url: 'https://jamesclear.com/atomic-habits'
        });
      }
      
      if (resources.length === 0) {
        return '<p style="color: var(--text-secondary);">Keep up the great work! ðŸŽ‰</p>';
      }
      
      return resources.map(r => `
        <div class="resource-item">
          <div class="resource-info">
            <div class="resource-type">${r.type}</div>
            <div class="resource-title">${r.title}</div>
            <div class="resource-relevance">${r.relevance}</div>
          </div>
          <a href="${r.url}" target="_blank" class="resource-link">
            ${r.type === 'podcast' ? 'ðŸŽ§' : r.type === 'book' ? 'ðŸ“–' : 'ðŸ“„'} View
          </a>
        </div>
      `).join('');
    }

    function closeWeeklySummary() {
      document.getElementById('weeklySummaryModal').style.display = 'none';
    }

    function emailWeeklySummary() {
      const summaryContent = document.getElementById('weeklySummaryContent').innerText;
      const subject = `Your GC Stride Weekly Summary - ${new Date().toLocaleDateString()}`;
      const email = data.profile && data.profile.email ? data.profile.email : 'lklevin1@gmail.com';
      const mailtoLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${email}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(summaryContent)}`;
      window.open(mailtoLink, '_blank');
    }

    function copyWeeklySummary() {
      const summaryContent = document.getElementById('weeklySummaryContent').innerText;
      navigator.clipboard.writeText(summaryContent).then(() => {
        showToast('Summary copied to clipboard! ðŸ“‹');
      });
    }

    // Helper function
    function getTodayDateString() {
      const today = new Date();
      return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    }

    // Auto-save every 30 seconds
    setInterval(() => {
      if (!data.settings.vacationMode) {
        saveData();
      }
    }, 30000);
    
    // ==================== PWA & UPDATE SYSTEM ====================
    
    const APP_VERSION = '2.0.0';
    
    // Register service worker for offline support and updates
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Inline service worker
        const swCode = `
          const CACHE_NAME = 'gc-stride-v${APP_VERSION}';
          self.addEventListener('install', e => {
            e.waitUntil(self.skipWaiting());
          });
          self.addEventListener('activate', e => {
            e.waitUntil(
              caches.keys().then(keys => 
                Promise.all(keys.map(key => key !== CACHE_NAME && caches.delete(key)))
              ).then(() => self.clients.claim())
            );
          });
          self.addEventListener('fetch', e => {
            e.respondWith(
              fetch(e.request)
                .then(r => {
                  const rc = r.clone();
                  caches.open(CACHE_NAME).then(c => c.put(e.request, rc));
                  return r;
                })
                .catch(() => caches.match(e.request))
            );
          });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(reg => {
            console.log('âœ… Service Worker registered - App can work offline!');
            
            // Check for updates
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdateNotification();
                }
              });
            });
            
            // Check for updates every hour
            setInterval(() => reg.update(), 3600000);
          })
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
    
    // Show update notification
    function showUpdateNotification() {
      const updateBanner = document.createElement('div');
      updateBanner.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #D97757, #E89B7D);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 16px;
        animation: slideDown 0.4s ease-out;
        max-width: 90%;
      `;
      updateBanner.innerHTML = `
        <span style="font-weight: 600; font-size: 0.9375em;">ðŸŽ‰ New version available!</span>
        <button onclick="window.location.reload()" style="
          background: white;
          color: #D97757;
          border: none;
          padding: 8px 16px;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
          font-size: 0.875em;
        ">Update Now</button>
        <button onclick="this.parentElement.remove()" style="
          background: transparent;
          color: white;
          border: 1px solid white;
          padding: 8px 16px;
          border-radius: 6px;
          font-weight: 600;
          cursor: pointer;
          font-size: 0.875em;
        ">Later</button>
      `;
      document.body.appendChild(updateBanner);
    }
    
    // Add slideDown animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideDown {
        from {
          transform: translateX(-50%) translateY(-100px);
          opacity: 0;
        }
        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(style);
    
    // Check version and show what's new
    const lastVersion = localStorage.getItem('appVersion');
    if (lastVersion && lastVersion !== APP_VERSION) {
      setTimeout(() => {
        const whatsNew = document.createElement('div');
        whatsNew.className = 'toast';
        whatsNew.style.background = 'linear-gradient(135deg, #5BA883, #7DBEAA)';
        whatsNew.innerHTML = `
          <span class="toast-message">âœ¨ Updated to v${APP_VERSION}!</span>
        `;
        document.body.appendChild(whatsNew);
        setTimeout(() => whatsNew.remove(), 3000);
      }, 2000);
    }
    localStorage.setItem('appVersion', APP_VERSION);
    
    // Add install prompt for PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button
      const installBtn = document.createElement('button');
      installBtn.className = 'btn btn-primary';
      installBtn.textContent = 'ðŸ“± Install App';
      installBtn.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        box-shadow: 0 8px 24px rgba(217, 119, 87, 0.4);
        animation: pulse 2s infinite;
      `;
      installBtn.onclick = async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === 'accepted') {
            console.log('App installed!');
          }
          deferredPrompt = null;
          installBtn.remove();
        }
      };
      
      // Only show if not already installed
      if (!window.matchMedia('(display-mode: standalone)').matches) {
        document.body.appendChild(installBtn);
        
        // Auto-hide after 10 seconds
        setTimeout(() => installBtn.remove(), 10000);
      }
    });
    
    // Display version in console
    console.log(`
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                                       â•‘
      â•‘         GC STRIDE v${APP_VERSION}            â•‘
      â•‘                                       â•‘
      â•‘    Health & Wellness Tracker          â•‘
      â•‘    Progressive Web App                â•‘
      â•‘                                       â•‘
      â•‘    âœ… Offline Support                 â•‘
      â•‘    âœ… Auto Updates                    â•‘
      â•‘    âœ… Apple Watch Integration         â•‘
      â•‘                                       â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `);
  </script>
</body>
</html>
